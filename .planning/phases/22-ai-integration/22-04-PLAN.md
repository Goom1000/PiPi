---
phase: 22-ai-integration
plan: 04
type: execute
wave: 3
depends_on: ["22-02", "22-03"]
files_modified:
  - components/PresentationView.tsx
  - services/aiProvider.ts
autonomous: true

must_haves:
  truths:
    - "Teacher launches Millionaire and receives progressive difficulty questions"
    - "Teacher launches Chase/Beat the Chaser and receives consistent difficulty questions"
    - "Game launches use slide context (cumulative content from all slides up to current)"
    - "Generation failures auto-retry 2-3 times before showing error"
  artifacts:
    - path: "components/PresentationView.tsx"
      provides: "Updated game launch flow using generateGameQuestions"
      contains: "generateGameQuestions"
    - path: "services/aiProvider.ts"
      provides: "buildSlideContext helper function"
      contains: "buildSlideContext"
  key_links:
    - from: "components/PresentationView.tsx"
      to: "services/aiProvider.ts"
      via: "buildSlideContext import"
      pattern: "import.*buildSlideContext.*from.*aiProvider"
    - from: "components/PresentationView.tsx"
      to: "provider.generateGameQuestions"
      via: "game launch call"
      pattern: "provider\\.generateGameQuestions"
---

<objective>
Integrate game-specific question generation into the game launch flow with auto-retry logic.

Purpose: Connect the new AI generation capability to the actual game launch UX. When teacher clicks Millionaire or Chase, the app now generates appropriate difficulty-calibrated questions.

Output:
- buildSlideContext helper function in aiProvider.ts
- Updated launchMillionaire to use generateGameQuestions
- withRetry helper for auto-retry on transient failures
- Chase/Beat the Chaser launch functions (for when games are implemented)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-ai-integration/22-CONTEXT.md
@.planning/phases/22-ai-integration/22-01-SUMMARY.md
@.planning/phases/22-ai-integration/22-02-SUMMARY.md
@.planning/phases/22-ai-integration/22-03-SUMMARY.md
@components/PresentationView.tsx
@services/aiProvider.ts
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add buildSlideContext helper to aiProvider.ts</name>
  <files>services/aiProvider.ts</files>
  <action>
1. Add import for Slide type at the top:
```typescript
import { Slide, LessonResource, AIProvider, GameType, GameDifficulty } from '../types';
```

2. Add buildSlideContext helper function (after BLOOM_DIFFICULTY_MAP, before AIProviderError):
```typescript
// Helper to build slide context for question generation
export function buildSlideContext(slides: Slide[], currentIndex: number): SlideContext {
  const relevantSlides = slides.slice(0, currentIndex + 1);
  const cumulativeContent = relevantSlides
    .map((s, i) => `Slide ${i + 1} (${s.title}): ${s.content.join('; ')}`)
    .join('\n\n');

  return {
    lessonTopic: slides[0]?.title || 'Unknown Topic',
    cumulativeContent,
    currentSlideTitle: slides[currentIndex]?.title || 'Current Slide',
    currentSlideContent: slides[currentIndex]?.content || []
  };
}
```

3. Add withRetry helper function (after buildSlideContext):
```typescript
// Helper for auto-retry with exponential backoff
export async function withRetry<T>(
  operation: () => Promise<T>,
  maxRetries: number = 3,
  initialDelay: number = 1000
): Promise<T> {
  let lastError: Error | undefined;

  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      return await operation();
    } catch (e) {
      lastError = e as Error;

      // Only retry on transient errors
      if (e instanceof AIProviderError) {
        const retryableCodes: AIErrorCode[] = ['NETWORK_ERROR', 'RATE_LIMIT', 'SERVER_ERROR'];
        if (!retryableCodes.includes(e.code)) {
          throw e; // Don't retry AUTH_ERROR, PARSE_ERROR, etc.
        }
      }

      if (attempt < maxRetries - 1) {
        await new Promise(resolve => setTimeout(resolve, initialDelay * Math.pow(2, attempt)));
      }
    }
  }

  throw lastError;
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>
- buildSlideContext function exported from aiProvider.ts
- withRetry function exported from aiProvider.ts
- Both functions are pure helpers with no side effects
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PresentationView to use generateGameQuestions</name>
  <files>components/PresentationView.tsx</files>
  <action>
1. Update imports from aiProvider (add buildSlideContext, withRetry, GameQuestionRequest):
```typescript
import { AIProviderError, buildSlideContext, withRetry, GameQuestionRequest } from '../services/aiProvider';
```

2. Update launchMillionaire function (around line 337) to use new API.
Replace the existing implementation with:

```typescript
  // Launch Millionaire (async question generation with progressive difficulty)
  const launchMillionaire = useCallback(async (questionCount: 3 | 5 | 10) => {
    if (!provider) {
      onRequestAI('start the Millionaire game');
      return;
    }

    // Show loading state immediately
    setActiveGame({
      gameType: 'millionaire',
      status: 'loading',
      questions: [],
      currentQuestionIndex: 0,
      selectedOption: null,
      lifelines: { fiftyFifty: true, phoneAFriend: true, askTheAudience: true },
      prizeLadder: [],
      currentPrize: 0,
      eliminatedOptions: [],
      audiencePoll: null,
      phoneHint: null,
      safeHavenAmount: 0,
      questionCount,
    });

    try {
      const slideContext = buildSlideContext(slides, currentIndex);
      const request: GameQuestionRequest = {
        gameType: 'millionaire',
        difficulty: 'medium', // Ignored for Millionaire (uses progressive)
        questionCount,
        slideContext,
      };

      const questions = await withRetry(
        () => provider.generateGameQuestions(request),
        3,  // max retries
        1000 // initial delay
      );

      if (questions.length === 0) {
        throw new AIProviderError('No questions generated', 'PARSE_ERROR');
      }

      setActiveGame(createMillionaireState(questions, questionCount));
    } catch (e) {
      console.error(e);
      if (e instanceof AIProviderError) {
        onError('Quiz Generation Failed', e.userMessage);
      } else {
        onError('Quiz Generation Failed', 'An unexpected error occurred');
      }
      setActiveGame(null);
    }
  }, [provider, slides, currentIndex, createMillionaireState, onRequestAI, onError]);
```

3. Update launchQuickQuiz function (around line 310) to also use buildSlideContext for consistency (optional but keeps patterns aligned).

Keep Quick Quiz using generateImpromptuQuiz for now (it doesn't need difficulty progression), but we can add the slideContext pattern later if needed.

4. Note: Chase and Beat the Chaser are still placeholder games. Their launch functions will be added in Phase 23/24 when those games are implemented. For now, they continue to use createPlaceholderState.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Run dev server: `npm run dev`
3. Test: Launch Millionaire game with 3 questions - should generate questions with progressive difficulty
4. Test: If AI unavailable, shows "enable AI" prompt
5. Test: If generation fails, shows error toast
  </verify>
  <done>
- launchMillionaire uses provider.generateGameQuestions with GameQuestionRequest
- Slide context is built using buildSlideContext helper
- Auto-retry (3 attempts) on transient failures
- Error handling shows user-friendly messages
- Quick Quiz still works (unchanged)
- Chase/Beat the Chaser still show placeholder (unchanged)
  </done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - should complete with no errors
2. Run `npm run dev` and test game launches:
   - Millionaire: Should generate questions (check console for any errors)
   - Quick Quiz: Should still work as before
   - Chase/Beat the Chaser: Should show placeholder
3. Test error handling: Disconnect network and try to launch game
</verification>

<success_criteria>
- TypeScript compilation passes
- Millionaire game launches with generateGameQuestions
- Slide context includes cumulative content from all slides up to current
- Auto-retry logic handles transient failures
- Error messages are user-friendly
- Quick Quiz continues to work
- No regression in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/22-ai-integration/22-04-SUMMARY.md`
</output>
