---
phase: 27-verbosity-ui-generation
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - components/PresentationView.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher can see three verbosity levels (Concise / Standard / Detailed) in teleprompter panel"
    - "Verbosity selector appears at top of teleprompter panel (below header)"
    - "Current verbosity level is visually highlighted"
    - "Switching verbosity shows loading indicator while regenerating"
    - "Teleprompter regenerates on-demand when verbosity changed (non-standard)"
    - "Standard verbosity shows existing speakerNotes without regeneration"
  artifacts:
    - path: "components/PresentationView.tsx"
      provides: "Verbosity selector UI, state management, regeneration handler"
      contains: "VerbosityLevel|verbosityLevel|isRegenerating|handleVerbosityChange"
  key_links:
    - from: "components/PresentationView.tsx"
      to: "services/aiProvider.ts"
      via: "provider.regenerateTeleprompter call"
      pattern: "provider.*regenerateTeleprompter"
    - from: "verbosity selector buttons"
      to: "handleVerbosityChange handler"
      via: "onClick handler"
      pattern: "onClick.*handleVerbosityChange"
---

<objective>
Add verbosity selector UI to the teleprompter panel and wire it to AI regeneration.

Purpose: Allow teachers to switch between Concise, Standard, and Detailed teleprompter scripts mid-lesson. The selector appears in the teleprompter panel header area, with visual feedback for the active level and loading state during regeneration.

Output: Working verbosity toggle in PresentationView that regenerates teleprompter content when non-standard levels are selected.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-verbosity-ui-generation/27-RESEARCH.md
@.planning/phases/27-verbosity-ui-generation/27-01-SUMMARY.md
@components/PresentationView.tsx
@services/aiProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add verbosity state and regeneration handler</name>
  <files>components/PresentationView.tsx</files>
  <action>
**Add imports at top of file:**
```typescript
import { VerbosityLevel } from '../services/aiProvider';
```

**Add new state variables** (near other useState declarations around line 100-150):
```typescript
// Verbosity control for teleprompter scripts
const [verbosityLevel, setVerbosityLevel] = useState<VerbosityLevel>('standard');
const [isRegenerating, setIsRegenerating] = useState(false);
const [regeneratedScript, setRegeneratedScript] = useState<string | null>(null);
```

**Add regeneration handler** (near other handlers like handleGenerateQuestion):
```typescript
// Handle verbosity level change - regenerate teleprompter if needed
const handleVerbosityChange = async (newLevel: VerbosityLevel) => {
    if (newLevel === verbosityLevel) return;

    // Standard mode uses original speakerNotes - no regeneration needed
    if (newLevel === 'standard') {
        setVerbosityLevel('standard');
        setRegeneratedScript(null);
        return;
    }

    // Concise/Detailed require AI regeneration
    if (!provider) {
        // No AI provider - can't regenerate
        return;
    }

    setVerbosityLevel(newLevel);
    setIsRegenerating(true);

    try {
        const newScript = await provider.regenerateTeleprompter(currentSlide, newLevel);
        setRegeneratedScript(newScript);
    } catch (error) {
        console.error('Failed to regenerate teleprompter:', error);
        // Revert to standard on error
        setVerbosityLevel('standard');
        setRegeneratedScript(null);
        // Show toast error if available
        if (error instanceof AIProviderError) {
            addToast(error.userMessage, 'error');
        }
    } finally {
        setIsRegenerating(false);
    }
};
```

**Reset regenerated script when slide changes** - add to existing useEffect that handles slide changes, or add new effect:
```typescript
// Reset verbosity to standard when slide changes
useEffect(() => {
    setVerbosityLevel('standard');
    setRegeneratedScript(null);
}, [currentIndex]);
```

**Import AIProviderError** if not already imported (check existing imports from aiProvider).
  </action>
  <verify>
Grep for new state: `grep -n "verbosityLevel\|isRegenerating\|regeneratedScript" components/PresentationView.tsx`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
PresentationView has verbosityLevel state (default: 'standard'), isRegenerating state, regeneratedScript state, and handleVerbosityChange async handler that calls provider.regenerateTeleprompter for non-standard levels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add verbosity selector UI and update script display</name>
  <files>components/PresentationView.tsx</files>
  <action>
**Add verbosity selector UI** - Insert after the teleprompter panel header (after line ~1223 with the progress dots), before the content area:

```tsx
{/* Verbosity Selector */}
<div className="flex justify-center items-center gap-2 px-3 py-2 border-b border-slate-700 bg-slate-800/30">
    <span className="text-[9px] font-bold text-slate-500 uppercase tracking-widest mr-2">Script Style</span>
    {(['concise', 'standard', 'detailed'] as const).map(level => (
        <button
            key={level}
            onClick={() => handleVerbosityChange(level)}
            disabled={isRegenerating || (!isAIAvailable && level !== 'standard')}
            className={`px-3 py-1.5 text-[10px] font-bold uppercase tracking-wider rounded-lg transition-all ${
                verbosityLevel === level
                    ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20'
                    : 'bg-slate-700 text-slate-400 hover:text-white hover:bg-slate-600'
            } ${(isRegenerating || (!isAIAvailable && level !== 'standard')) && verbosityLevel !== level ? 'opacity-50 cursor-not-allowed' : ''}`}
        >
            {level}
        </button>
    ))}
    {isRegenerating && (
        <div className="w-4 h-4 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin ml-2" />
    )}
</div>
```

**Update currentScriptSegment useMemo** to use regenerated script when available:

Find the existing `currentScriptSegment` useMemo (around line 935-969). Modify the beginning to check for regenerated content first:

```typescript
const currentScriptSegment = useMemo(() => {
    // If we have a regenerated script (concise/detailed), use it
    const rawScript = regeneratedScript || currentSlide.speakerNotes || "";
    const segments = rawScript.split('ðŸ‘‰');

    // ... rest of existing logic unchanged ...
}, [currentSlide.speakerNotes, visibleBullets, showFullScript, studentAssignments, currentIndex, currentSlide.content, currentSlide.title, regeneratedScript]);
```

Note: Add `regeneratedScript` to the dependency array.

**Add loading overlay to script display area** - In the content area (around line 1238), wrap the MarkdownText with a conditional loading state:

```tsx
<div className="text-xl md:text-2xl leading-relaxed font-sans text-slate-100 animate-fade-in whitespace-pre-wrap relative">
    {isRegenerating && (
        <div className="absolute inset-0 bg-slate-900/80 flex items-center justify-center rounded-lg">
            <div className="flex items-center gap-3 text-indigo-400">
                <div className="w-6 h-6 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin" />
                <span className="text-sm font-medium">Regenerating script...</span>
            </div>
        </div>
    )}
    <MarkdownText text={currentScriptSegment} />
</div>
```
  </action>
  <verify>
Visual check: Run `npm run dev`, open presentation mode, verify:
1. Three verbosity buttons visible below "Presenter Console" header
2. "Standard" is highlighted by default (indigo background)
3. Clicking "Concise" or "Detailed" shows spinner and loading overlay
4. Script content updates after regeneration completes
5. Clicking "Standard" immediately shows original script (no loading)

TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Teleprompter panel shows verbosity selector with three buttons (Concise/Standard/Detailed). Standard is default and highlighted. Non-standard levels trigger AI regeneration with loading indicator. Script display shows regenerated content when available.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Run dev server: `npm run dev`
3. Open any presentation in present mode
4. Verify verbosity selector appears below "Presenter Console" header
5. Verify Standard is highlighted by default
6. Click Concise - loading spinner appears, script regenerates to brief style
7. Click Standard - immediately shows original script (no API call)
8. Click Detailed - loading spinner appears, script regenerates to full script style
9. Navigate to next slide - resets to Standard automatically
10. Without AI provider configured, Concise/Detailed buttons are disabled (grayed out)
</verification>

<success_criteria>
- VERB-01: Teacher sees three verbosity levels in teleprompter panel
- VERB-02: Verbosity selector at top of panel (below header, above content)
- VERB-03: Current level visually highlighted with indigo background
- VERB-04: Loading indicator during regeneration (spinner + overlay)
- VERB-05: Concise produces minimal guidance (verified by output)
- VERB-06: Standard shows existing speakerNotes unchanged
- VERB-07: Detailed produces full script with transitions
- VERB-08: Teleprompter regenerates when verbosity changed
</success_criteria>

<output>
After completion, create `.planning/phases/27-verbosity-ui-generation/27-02-SUMMARY.md`
</output>
