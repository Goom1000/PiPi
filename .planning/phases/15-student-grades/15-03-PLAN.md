---
phase: 15-student-grades
plan: 03
type: execute
wave: 3
depends_on: ["15-02"]
files_modified:
  - App.tsx
  - hooks/useClassBank.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Exported .pipi files include grade data from active class"
    - "Imported .pipi files restore grade assignments to class bank"
  artifacts:
    - path: "App.tsx"
      provides: "Grade data passed to createPiPiFile, grade data restored from loaded file"
      contains: "studentGrades"
    - path: "hooks/useClassBank.ts"
      provides: "saveClass accepts optional studentData for grade restoration"
      contains: "studentData?: StudentWithGrade[]"
  key_links:
    - from: "App.tsx"
      to: "services/saveService.ts"
      via: "createPiPiFile call with studentGrades parameter"
      pattern: "createPiPiFile.*studentGrades"
    - from: "App.tsx"
      to: "hooks/useClassBank.ts"
      via: "saveClass call with studentGrades from loaded file"
      pattern: "saveClass.*studentGrades"
---

<objective>
Wire grade data through export and import flows in App.tsx.

Purpose: Close the final gaps in Phase 15. The infrastructure (types, services, hooks) is complete, but App.tsx doesn't pass studentGrades when saving or restore them when loading.

Output: Working export/import preservation of student grades.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase
@.planning/phases/15-student-grades/15-01-SUMMARY.md
@.planning/phases/15-student-grades/15-02-SUMMARY.md

# Verification that identified these gaps
@.planning/phases/15-student-grades/15-VERIFICATION.md

# Files to modify
@App.tsx
@hooks/useClassBank.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pass studentGrades when saving .pipi files</name>
  <files>App.tsx</files>
  <action>
Wire grade data from the active class into the export flow.

1. Find `handleSaveClick` (around line 571). It currently calls:
   ```typescript
   const file = createPiPiFile(lessonTitle, slides, studentNames, lessonText);
   ```

   Update to look up the active class's studentData and pass it:
   ```typescript
   const handleSaveClick = useCallback(() => {
     // Look up active class's grade data
     const activeClass = activeClassName ? classes.find(c => c.name === activeClassName) : null;
     const studentGrades = activeClass?.studentData;

     // Check file size first
     const file = createPiPiFile(lessonTitle, slides, studentNames, lessonText, undefined, studentGrades);
     const sizeInfo = checkFileSize(file);
     // ... rest unchanged
   ```

   Note: The `classes` array is already available in App.tsx from `useClassBank()` hook destructuring at line 144.

2. Find `handleSaveConfirm` (around line 585). It currently calls:
   ```typescript
   const file = createPiPiFile(lessonTitle, slides, studentNames, lessonText);
   ```

   Update to match (same lookup pattern):
   ```typescript
   const handleSaveConfirm = useCallback(() => {
     // Look up active class's grade data
     const activeClass = activeClassName ? classes.find(c => c.name === activeClassName) : null;
     const studentGrades = activeClass?.studentData;

     const file = createPiPiFile(lessonTitle, slides, studentNames, lessonText, undefined, studentGrades);
     downloadPresentation(file, pendingSaveFilename);
     // ... rest unchanged
   ```

3. Update the dependency arrays for both callbacks to include `classes` and `activeClassName`:
   ```typescript
   }, [lessonTitle, slides, studentNames, lessonText, addToast, classes, activeClassName]);
   // and
   }, [lessonTitle, slides, studentNames, lessonText, pendingSaveFilename, addToast, classes, activeClassName]);
   ```

The `createPiPiFile` function signature (from 15-02) is:
`createPiPiFile(title, slides, studentNames, lessonText, existingFile?, studentGrades?)`
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Grep for "studentGrades" in App.tsx - should find usage in handleSaveClick and handleSaveConfirm.
  </verify>
  <done>
handleSaveClick and handleSaveConfirm pass active class's studentData to createPiPiFile. Exported .pipi files now include grade data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend saveClass to accept optional studentData parameter</name>
  <files>hooks/useClassBank.ts</files>
  <action>
Extend saveClass signature to accept optional studentData for grade restoration during import.

1. Find `saveClass` function (around line 98). Current signature:
   ```typescript
   const saveClass = useCallback((name: string, students: string[]) => {
   ```

   Update to accept optional studentData:
   ```typescript
   const saveClass = useCallback((name: string, students: string[], studentData?: StudentWithGrade[]) => {
   ```

2. Update the function body to use provided studentData when available. Current logic (around line 102-120) creates studentData from scratch:
   ```typescript
   setClasses(prev => {
     const existing = prev.find(c => c.name === trimmedName);
     if (existing) {
       // Update existing class
       const newStudentData = students.map(name => {
         const existingStudent = existing.studentData?.find(s => s.name === name);
         return existingStudent || { name, grade: null };
       });
       // ...
     } else {
       // Create new class
       const newClass: SavedClass = {
         id: crypto.randomUUID(),
         name: trimmedName,
         students,
         studentData: students.map(name => ({ name, grade: null })),
         // ...
       };
     }
   });
   ```

   Update to prefer provided studentData when creating new class OR when provided on update:
   ```typescript
   setClasses(prev => {
     const existing = prev.find(c => c.name === trimmedName);
     if (existing) {
       // Update existing class
       // If studentData provided, use it; otherwise merge as before
       const newStudentData = studentData
         ? students.map(name => {
             const provided = studentData.find(s => s.name === name);
             return provided || { name, grade: null };
           })
         : students.map(name => {
             const existingStudent = existing.studentData?.find(s => s.name === name);
             return existingStudent || { name, grade: null };
           });
       // ... rest unchanged
     } else {
       // Create new class - use provided studentData or create fresh
       const newStudentData = studentData
         ? students.map(name => {
             const provided = studentData.find(s => s.name === name);
             return provided || { name, grade: null };
           })
         : students.map(name => ({ name, grade: null }));

       const newClass: SavedClass = {
         id: crypto.randomUUID(),
         name: trimmedName,
         students,
         studentData: newStudentData,
         // ...
       };
     }
   });
   ```

3. Update the dependency array if needed (likely just `[]` as it only uses setState).

This enables App.tsx to pass grade data directly when loading .pipi files, handling both existing AND new class cases cleanly.
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Grep for "studentData?" in useClassBank.ts - should show optional parameter.
  </verify>
  <done>
saveClass accepts optional studentData parameter. When provided, uses it for grade initialization instead of creating null grades.
  </done>
</task>

<task type="auto">
  <name>Task 3: Restore studentGrades when loading .pipi files</name>
  <files>App.tsx</files>
  <action>
Wire grade data restoration into the import flow using the extended saveClass.

1. Find `handleLoadFile` (around line 603). After setting studentNames, add grade restoration:

   Current code:
   ```typescript
   const pipiFile = await readPiPiFile(file);
   setSlides(pipiFile.content.slides);
   setStudentNames(pipiFile.content.studentNames || []);
   setLessonText(pipiFile.content.lessonText || '');
   setLessonTitle(pipiFile.title);
   ```

   Add grade restoration after the existing state updates:
   ```typescript
   const pipiFile = await readPiPiFile(file);
   setSlides(pipiFile.content.slides);
   const loadedStudents = pipiFile.content.studentNames || [];
   setStudentNames(loadedStudents);
   setLessonText(pipiFile.content.lessonText || '');
   setLessonTitle(pipiFile.title);

   // Restore grade data if present - save as class with grades
   const loadedGrades = pipiFile.content.studentGrades;
   if (loadedGrades && loadedGrades.length > 0 && loadedStudents.length > 0) {
     const className = pipiFile.title || 'Imported Class';
     // saveClass now accepts studentData - handles both new and existing classes
     saveClass(className, loadedStudents, loadedGrades);
     setActiveClassName(className);
   }
   ```

2. Update handleLoadFile's dependency array to include saveClass:
   ```typescript
   }, [hasUnsavedChanges, addToast, saveClass]);
   ```

This handles BOTH cases:
- Existing class: saveClass updates it, using provided grades (or preserving existing where names match)
- New class: saveClass creates it with the provided grades already populated

No setTimeout, no useEffect, no race conditions - saveClass handles everything synchronously.
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Run `npm run build` - should build successfully.
Grep for "studentGrades" in App.tsx - should find usage in handleLoadFile.
Grep for "saveClass.*loadedGrades" in App.tsx - should show grade data being passed.
  </verify>
  <done>
handleLoadFile passes studentGrades to saveClass when loading .pipi files. Both existing and new classes receive grade data correctly.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit` passes
2. Build succeeds: `npm run build` completes without errors
3. Export wiring: `grep -n "studentGrades" App.tsx` shows usage in save functions
4. Import wiring: `grep -n "saveClass.*loadedGrades" App.tsx` shows grade restoration
5. Hook extension: `grep -n "studentData?" hooks/useClassBank.ts` shows optional parameter
6. Manual test flow:
   - Create class with students
   - Assign grades to students in Manage Classes modal
   - Save presentation as .pipi file
   - Clear app state (refresh or new session)
   - Load the .pipi file
   - Check that grades are restored in Manage Classes modal (works for BOTH existing and new classes)
</verification>

<success_criteria>
- handleSaveClick passes active class studentData to createPiPiFile
- handleSaveConfirm passes active class studentData to createPiPiFile
- saveClass accepts optional studentData parameter for grade initialization
- handleLoadFile reads content.studentGrades and passes to saveClass
- Grade restoration works for BOTH existing classes AND newly imported classes
- App builds and runs without TypeScript errors
- Verification report gap #5 is closed: "Saved classes include grade data when exported/imported"
</success_criteria>

<output>
After completion, create `.planning/phases/15-student-grades/15-03-SUMMARY.md`
</output>
