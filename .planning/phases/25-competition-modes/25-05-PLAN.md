---
phase: 25-competition-modes
plan: 05
type: execute
wave: 4
depends_on: ["25-03", "25-04"]
files_modified:
  - types.ts
  - components/PresentationView.tsx
  - components/games/BeatTheChaserGame.tsx
  - components/StudentGameView.tsx
autonomous: true

must_haves:
  truths:
    - "Competition mode is stored in game state and synced to student view"
    - "Score updates when questions are answered correctly"
    - "Active team rotates on question completion"
    - "Score overlay appears during gameplay on teacher view"
    - "Score display appears during gameplay on student view"
  artifacts:
    - path: "types.ts"
      provides: "BaseGameState extended with competitionMode"
      contains: "competitionMode?: CompetitionMode"
    - path: "components/PresentationView.tsx"
      provides: "Score tracking and display integration"
      contains: "ScoreOverlay"
    - path: "components/StudentGameView.tsx"
      provides: "Student score display integration"
      contains: "ScoreDisplay"
  key_links:
    - from: "components/PresentationView.tsx"
      to: "components/games/shared/ScoreOverlay.tsx"
      via: "import ScoreOverlay"
      pattern: "import ScoreOverlay"
    - from: "components/StudentGameView.tsx"
      to: "components/games/shared/ScoreDisplay.tsx"
      via: "import ScoreDisplay"
      pattern: "import ScoreDisplay"
---

<objective>
Wire competition mode through game state and add score tracking.

Purpose: Connect competition mode configuration to game execution, track scores on correct answers, rotate active team, and display scores on both teacher and student views.

Output: Complete competition mode integration with score tracking and display
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-competition-modes/25-CONTEXT.md
@.planning/phases/25-competition-modes/25-03-SUMMARY.md
@.planning/phases/25-competition-modes/25-04-SUMMARY.md
@types.ts
@components/PresentationView.tsx
@components/games/BeatTheChaserGame.tsx
@components/StudentGameView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend BaseGameState with competition mode</name>
  <files>types.ts</files>
  <action>
Update `types.ts` to add competitionMode to BaseGameState:

1. **Add competitionMode to BaseGameState** (around line 44):
```typescript
// Base properties shared across all game types
export interface BaseGameState {
  gameType: GameType;
  status: GameStatus;
  questions: QuizQuestion[];
  currentQuestionIndex: number;
  competitionMode?: CompetitionMode;  // Optional for backward compatibility
}
```

The field is optional (`?`) to maintain backward compatibility with existing game state creation that doesn't include competition mode. When undefined, UI components will not render score overlays.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Search for field: `grep "competitionMode" types.ts`
  </verify>
  <done>
BaseGameState includes optional competitionMode field
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate score tracking in PresentationView</name>
  <files>components/PresentationView.tsx</files>
  <action>
Update `components/PresentationView.tsx` to:

1. **Add ScoreOverlay import** (near other imports):
```typescript
import ScoreOverlay from './games/shared/ScoreOverlay';
```

2. **Pass competition mode when creating game states**:

For Quick Quiz (in the Quick Quiz setup modal Start button handler):
```typescript
onClick={() => {
  setShowQuickQuizSetup(false);
  setPendingGameType('quick-quiz');
  // Store competition mode for use when game state is created
  launchQuickQuiz(competitionMode);
}}
```

Update `launchQuickQuiz` function signature and implementation to accept and store competition mode:
```typescript
const launchQuickQuiz = useCallback(async (compMode?: CompetitionMode) => {
  // ... existing code ...
  // When creating the game state, include competition mode:
  setActiveGame({
    gameType: 'quick-quiz',
    status: 'playing',
    questions: newQuestions,
    currentQuestionIndex: 0,
    isAnswerRevealed: false,
    competitionMode: compMode  // Add this
  });
  // ... rest of function ...
}, [/* existing deps */]);
```

For Millionaire (in `launchMillionaire`):
```typescript
const launchMillionaire = useCallback(async (questionCount: 3 | 5 | 10) => {
  // ... existing code ...
  setActiveGame({
    // ... existing fields ...
    competitionMode  // Add this (uses state variable)
  });
  setShowMillionaireSetup(false);
}, [/* deps, add competitionMode */]);
```

For The Chase (in `launchTheChase`):
```typescript
const launchTheChase = useCallback(async (difficulty: GameDifficulty, isAIControlled: boolean) => {
  // ... existing code ...
  setActiveGame({
    // ... existing fields ...
    competitionMode  // Add this
  });
  setShowChaseSetup(false);
}, [/* deps, add competitionMode */]);
```

For Beat the Chaser (in `createBeatTheChaserState`):
```typescript
const createBeatTheChaserState = useCallback((compMode?: CompetitionMode): BeatTheChaserState => {
  return {
    // ... existing fields ...
    competitionMode: compMode  // Add this
  };
}, []);
```

3. **Add score update handler**:
```typescript
const handleUpdateScore = useCallback((teamIndex: number, delta: number) => {
  if (!activeGame?.competitionMode || activeGame.competitionMode.mode !== 'team') return;

  const newTeams = activeGame.competitionMode.teams.map((team, i) =>
    i === teamIndex ? { ...team, score: Math.max(0, team.score + delta) } : team
  );

  setActiveGame(prev => {
    if (!prev || !prev.competitionMode || prev.competitionMode.mode !== 'team') return prev;
    return {
      ...prev,
      competitionMode: {
        ...prev.competitionMode,
        teams: newTeams
      }
    };
  });
}, [activeGame]);
```

4. **Add score increment on correct answer** (in `handleNextQuestion` for Quick Quiz):
```typescript
const handleNextQuestion = useCallback(() => {
  if (activeGame?.gameType === 'quick-quiz') {
    const state = activeGame as QuickQuizState;

    // Check if answer was correct and update score
    let updatedCompetitionMode = state.competitionMode;
    if (state.competitionMode?.mode === 'team' && state.isAnswerRevealed) {
      const currentQ = state.questions[state.currentQuestionIndex];
      // Note: Quick Quiz doesn't track selected answer, so skip scoring
      // Scoring is more relevant for Millionaire/Chase where answer is tracked
    }

    // Rotate active team
    if (updatedCompetitionMode?.mode === 'team') {
      const nextTeamIndex = (updatedCompetitionMode.activeTeamIndex + 1) % updatedCompetitionMode.teams.length;
      updatedCompetitionMode = {
        ...updatedCompetitionMode,
        activeTeamIndex: nextTeamIndex
      };
    }

    if (state.currentQuestionIndex < state.questions.length - 1) {
      setActiveGame({
        ...state,
        currentQuestionIndex: state.currentQuestionIndex + 1,
        isAnswerRevealed: false,
        status: 'playing',
        competitionMode: updatedCompetitionMode
      });
    } else {
      setActiveGame({ ...state, status: 'result', competitionMode: updatedCompetitionMode });
    }
  }
}, [activeGame]);
```

5. **Add ScoreOverlay to game display** (in the GameContainer render area):
```jsx
{/* Game View */}
{activeGame && (
  <div className="fixed inset-0 z-[100]">
    <GameContainer
      state={activeGame}
      // ... existing props ...
    />

    {/* Score Overlay - Teacher View */}
    {activeGame.competitionMode && (
      <ScoreOverlay
        competitionMode={activeGame.competitionMode}
        onUpdateScore={handleUpdateScore}
      />
    )}
  </div>
)}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Search for ScoreOverlay: `grep "ScoreOverlay" components/PresentationView.tsx`
Search for competitionMode passing: `grep "competitionMode" components/PresentationView.tsx | wc -l`
  </verify>
  <done>
PresentationView passes competition mode to game states, displays ScoreOverlay, and handles score updates
  </done>
</task>

<task type="auto">
  <name>Task 3: Update BeatTheChaserGame to handle competition mode</name>
  <files>components/games/BeatTheChaserGame.tsx</files>
  <action>
Update `components/games/BeatTheChaserGame.tsx` to accept competition mode from SetupModal:

1. **Update handleSetupComplete** to accept competitionMode:
```typescript
const handleSetupComplete = useCallback((
  selectedDifficulty: BeatTheChaserDifficulty,
  aiControlled: boolean,
  compMode: CompetitionMode
) => {
  setDifficulty(selectedDifficulty);
  setIsAIControlled(aiControlled);
  setLocalPhase('cash-builder');

  updateState({
    phase: 'cash-builder',
    chaserDifficulty: selectedDifficulty,
    isAIControlled: aiControlled,
    accumulatedTime: 0,
    cashBuilderQuestionsAnswered: 0,
    cashBuilderCorrectAnswers: 0,
    competitionMode: compMode  // Add this
  });
}, [updateState]);
```

2. **Update SetupModal call**:
```jsx
case 'setup':
  return (
    <SetupModal
      onStart={handleSetupComplete}
      onCancel={onClose}
    />
  );
```

The SetupModal already passes competitionMode per Plan 04, so BeatTheChaserGame just needs to forward it to the state update.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Search for competitionMode: `grep "competitionMode" components/games/BeatTheChaserGame.tsx`
  </verify>
  <done>
BeatTheChaserGame accepts and forwards competition mode from SetupModal
  </done>
</task>

<task type="auto">
  <name>Task 4: Add ScoreDisplay to StudentGameView</name>
  <files>components/StudentGameView.tsx</files>
  <action>
Update `components/StudentGameView.tsx` to display scores:

1. **Add ScoreDisplay import**:
```typescript
import ScoreDisplay from './games/shared/ScoreDisplay';
```

2. **Add ScoreDisplay to all game views** that are in playing state.

Wrap the score display in a fragment or add it after each game view component. The cleanest approach is to add it once at the top level, after the game-specific rendering.

Update the main component to include ScoreDisplay when competitionMode is present:

```typescript
const StudentGameView: React.FC<StudentGameViewProps> = ({ gameState }) => {
  // ... existing loading/splash/result handling ...

  // Create a wrapper component that includes score display
  const renderWithScoreDisplay = (gameContent: React.ReactNode) => {
    return (
      <>
        {gameContent}
        {gameState.competitionMode && (
          <ScoreDisplay competitionMode={gameState.competitionMode} />
        )}
      </>
    );
  };

  // Game-specific rendering based on discriminated union (playing/reveal status)
  if (gameState.gameType === 'quick-quiz') {
    return renderWithScoreDisplay(<QuickQuizStudentView state={gameState} />);
  }

  if (gameState.gameType === 'millionaire') {
    return renderWithScoreDisplay(<MillionaireStudentView state={gameState} />);
  }

  if (gameState.gameType === 'the-chase') {
    return renderWithScoreDisplay(<TheChaseStudentView state={gameState} />);
  }

  if (gameState.gameType === 'beat-the-chaser') {
    return renderWithScoreDisplay(<BeatTheChaserStudentView state={gameState} />);
  }

  // Fallback for any future placeholder games
  return renderWithScoreDisplay(<PlaceholderStudentView gameType={gameState.gameType} />);
};
```

Alternative simpler approach - add ScoreDisplay at the end of each individual game view component. The wrapper approach above is cleaner and DRY.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Search for ScoreDisplay: `grep "ScoreDisplay" components/StudentGameView.tsx`
  </verify>
  <done>
StudentGameView displays ScoreDisplay overlay when competition mode is active
  </done>
</task>

</tasks>

<verification>
```bash
# TypeScript compiles
npx tsc --noEmit

# Competition mode in types
grep "competitionMode" types.ts

# ScoreOverlay in teacher view
grep "ScoreOverlay" components/PresentationView.tsx

# ScoreDisplay in student view
grep "ScoreDisplay" components/StudentGameView.tsx

# Competition mode passed to game states
grep -c "competitionMode" components/PresentationView.tsx
```
</verification>

<success_criteria>
- [ ] BaseGameState has optional competitionMode field
- [ ] Competition mode passed to all game state factories
- [ ] ScoreOverlay displays on teacher view during gameplay
- [ ] ScoreDisplay displays on student view during gameplay
- [ ] Score updates work via +/- buttons on teacher view
- [ ] Active team rotates on question advancement
- [ ] All TypeScript compiles without errors
- [ ] Game state syncs to student view via BroadcastChannel
</success_criteria>

<output>
After completion, create `.planning/phases/25-competition-modes/25-05-SUMMARY.md`
</output>
