---
phase: 18-student-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types.ts
  - components/PresentationView.tsx
  - components/StudentView.tsx
  - index.html
autonomous: true

must_haves:
  truths:
    - "When teacher clicks Question button in Targeted mode, student's name appears on student view"
    - "Banner shows 'Question for [Name]' format"
    - "Banner appears as overlay at top of student view"
    - "Banner auto-dismisses after 3 seconds with fade-out animation"
    - "Banner clears immediately when teacher navigates to a new slide"
    - "Long names display with smaller font (remain readable)"
  artifacts:
    - path: "types.ts"
      provides: "STUDENT_SELECT and STUDENT_CLEAR message types"
      contains: "STUDENT_SELECT"
    - path: "components/PresentationView.tsx"
      provides: "Broadcast STUDENT_SELECT on question generation, STUDENT_CLEAR on slide change"
      contains: "STUDENT_SELECT"
    - path: "components/StudentView.tsx"
      provides: "Banner state management and StudentNameBanner component"
      contains: "StudentNameBanner"
    - path: "index.html"
      provides: "CSS animations for banner entrance and exit"
      contains: "slideDown"
  key_links:
    - from: "components/PresentationView.tsx"
      to: "types.ts"
      via: "postMessage with STUDENT_SELECT type"
      pattern: "postMessage.*STUDENT_SELECT"
    - from: "components/StudentView.tsx"
      to: "types.ts"
      via: "lastMessage.type === 'STUDENT_SELECT'"
      pattern: "lastMessage\\.type === 'STUDENT_SELECT'"
---

<objective>
Display selected student's name as a banner overlay on the student view when teacher generates a question in Targeted mode.

Purpose: Makes it visible to the whole class (on the projector) who has been called to answer the question.
Output: Working banner that appears on student view, synced via BroadcastChannel, with entrance/exit animations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-student-display/18-CONTEXT.md
@.planning/phases/18-student-display/18-RESEARCH.md

# Key source files
@types.ts
@components/PresentationView.tsx
@components/StudentView.tsx
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add message types and send student selection from teacher view</name>
  <files>types.ts, components/PresentationView.tsx</files>
  <action>
1. In `types.ts`, extend the PresentationMessage union with two new message types:
   ```typescript
   | { type: 'STUDENT_SELECT'; payload: { studentName: string } }
   | { type: 'STUDENT_CLEAR' }
   ```

2. In `PresentationView.tsx`, modify the Question button click handler (inside the Targeted mode block, around line 884-887) to broadcast STUDENT_SELECT after calling handleGenerateQuestion:
   ```typescript
   onClick={() => {
     handleGenerateQuestion(nextStudent.grade, nextStudent.name);
     setCyclingState(prev => advanceCycling(prev, studentData));
     // Broadcast student selection to student view
     postMessage({ type: 'STUDENT_SELECT', payload: { studentName: nextStudent.name } });
   }}
   ```

3. In the existing useEffect that clears quickQuestion on slide change (around line 380-382), add a STUDENT_CLEAR broadcast when in Targeted mode:
   ```typescript
   useEffect(() => {
     setQuickQuestion(null);
     // Clear student banner on student view when slide changes
     if (isTargetedMode) {
       postMessage({ type: 'STUDENT_CLEAR' });
     }
   }, [currentIndex, postMessage, isTargetedMode]);
   ```

Note: The broadcast should happen immediately when the button is clicked, not after the AI call completes. This ensures instant sync.
  </action>
  <verify>
- TypeScript compiles without errors: `npm run build` (or `npx tsc --noEmit`)
- PresentationMessage union includes STUDENT_SELECT and STUDENT_CLEAR types
- Question button click broadcasts STUDENT_SELECT with studentName payload
- Slide change broadcasts STUDENT_CLEAR when in Targeted mode
  </verify>
  <done>
Types extended, teacher view broadcasts student selection on question click and clears on slide change.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add banner component and display logic to student view</name>
  <files>components/StudentView.tsx, index.html</files>
  <action>
1. In `index.html`, add CSS animations after the existing `animate-fade-in` block (around line 45):
   ```css
   .animate-slide-down {
     animation: slideDown 0.4s ease-out forwards;
   }
   @keyframes slideDown {
     from { opacity: 0; transform: translateY(-100%); }
     to { opacity: 1; transform: translateY(0); }
   }
   .animate-fade-out {
     animation: fadeOut 0.5s ease-in forwards;
   }
   @keyframes fadeOut {
     from { opacity: 1; }
     to { opacity: 0; }
   }
   ```

2. In `StudentView.tsx`:

   a. Add imports for useRef and useCallback (if not already present)

   b. Add state for banner display (after existing state declarations):
   ```typescript
   const [selectedStudent, setSelectedStudent] = useState<string | null>(null);
   const [isExiting, setIsExiting] = useState(false);
   const timerRef = useRef<number | null>(null);
   ```

   c. Add helper function for responsive font sizing (before the component return):
   ```typescript
   // Length-based font sizing for long names
   function getNameFontSize(name: string): string {
     const length = name.length;
     if (length <= 10) return 'text-6xl';
     if (length <= 15) return 'text-5xl';
     if (length <= 20) return 'text-4xl';
     if (length <= 30) return 'text-3xl';
     return 'text-2xl';
   }
   ```

   d. In the useEffect that handles incoming messages (around line 27), add handlers for the new message types:
   ```typescript
   // Handle student selection for banner display
   if (lastMessage.type === 'STUDENT_SELECT') {
     // Clear any existing timer
     if (timerRef.current) clearTimeout(timerRef.current);

     // Reset exit state and show new student
     setIsExiting(false);
     setSelectedStudent(lastMessage.payload.studentName);

     // Auto-dismiss after 3 seconds
     timerRef.current = window.setTimeout(() => {
       setIsExiting(true);
       // Wait for exit animation (500ms) before clearing
       setTimeout(() => setSelectedStudent(null), 500);
     }, 3000);
   }

   if (lastMessage.type === 'STUDENT_CLEAR') {
     // Immediate clear on slide change (no exit animation)
     if (timerRef.current) clearTimeout(timerRef.current);
     setSelectedStudent(null);
     setIsExiting(false);
   }
   ```

   e. Add cleanup effect for timer (after the message handler useEffect):
   ```typescript
   // Cleanup timer on unmount
   useEffect(() => {
     return () => {
       if (timerRef.current) clearTimeout(timerRef.current);
     };
   }, []);
   ```

   f. In the normal slide mode return (around line 79), wrap content in a relative container and add the banner overlay:
   ```tsx
   return (
     <div className="h-screen w-screen bg-black flex items-center justify-center overflow-hidden relative">
       {/* Student Name Banner */}
       {selectedStudent && (
         <div className={`absolute top-0 left-0 right-0 z-50 flex justify-center pt-8 ${isExiting ? 'animate-fade-out' : 'animate-slide-down'}`}>
           <div className="bg-indigo-600 px-12 py-6 rounded-2xl shadow-2xl">
             <p className="text-white text-xl font-medium mb-1 text-center">
               Question for
             </p>
             <p className={`text-white font-bold text-center ${getNameFontSize(selectedStudent)}`}>
               {selectedStudent}
             </p>
           </div>
         </div>
       )}

       {/* Slide content */}
       <div className="w-full h-full max-w-[1920px] max-h-[1080px] aspect-video bg-white">
         <SlideContentRenderer slide={currentSlide} visibleBullets={visibleBullets} />
       </div>
     </div>
   );
   ```

Note: The banner uses indigo-600 to match PiPi's brand colors (consistent with the quiz overlay). The `z-50` ensures it appears above the slide content.
  </action>
  <verify>
- `npm run dev` starts without errors
- Open presentation, load a class with grades, enable Targeted mode
- Click Question button - banner should slide down on student view showing "Question for [Name]"
- Wait 3 seconds - banner should fade out
- Navigate to next slide - banner should clear immediately (no exit animation)
- Test with a long name (20+ characters) - font should be smaller but readable
  </verify>
  <done>
Student view displays banner when teacher selects a student, with slide-down entrance, 3-second auto-dismiss with fade-out, and immediate clear on slide change.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Manual integration test:**
   - `npm run dev`
   - Upload a PDF or load a presentation
   - Load a class with at least one student with a grade assigned
   - Start presentation
   - Launch student view
   - Enable Targeted mode (toggle switch)
   - Click the Question button
   - Verify: Student view shows "Question for [Name]" banner at top
   - Wait 3 seconds
   - Verify: Banner fades out
   - Click Question button again (new student selected)
   - Navigate to next slide before 3 seconds elapse
   - Verify: Banner clears immediately on slide change

2. **Edge case tests:**
   - Long name (e.g., "Christopher Alexander Wellington"): Verify smaller font fits
   - Rapid clicks: New selection should restart the timer and show new name
   - Manual mode: No banner should appear (only in Targeted mode)

3. **TypeScript check:**
   - `npx tsc --noEmit` passes with no errors
</verification>

<success_criteria>
- DISP-01: Student name appears as overlay banner on student view - PASS
- DISP-02: Banner shows "Question for [Name]" format - PASS
- DISP-03: Banner synced to student view via BroadcastChannel - PASS
- Banner auto-dismisses after 3 seconds with fade-out
- Banner clears immediately on slide change
- Long names render with appropriately sized font
</success_criteria>

<output>
After completion, create `.planning/phases/18-student-display/18-01-SUMMARY.md`
</output>
