---
phase: v1.2-01-permission-state-loading
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hooks/useWindowManagement.ts
  - components/PresentationView.tsx
autonomous: true

must_haves:
  truths:
    - "Launch button shows 'Checking displays...' during initial permission query"
    - "No permission-related UI appears until async check completes"
    - "PermissionExplainer only appears when state is definitively 'prompt'"
  artifacts:
    - path: "hooks/useWindowManagement.ts"
      provides: "isLoading boolean in hook return type"
      exports: ["UseWindowManagementResult.isLoading"]
      contains: "isLoading: boolean"
    - path: "components/PresentationView.tsx"
      provides: "Loading-aware button and permission UI"
      contains: "Checking displays"
  key_links:
    - from: "hooks/useWindowManagement.ts"
      to: "components/PresentationView.tsx"
      via: "isLoading destructured from useWindowManagement()"
      pattern: "isLoading.*useWindowManagement"
    - from: "useEffect permission check"
      to: "setIsLoading(false)"
      via: "Called after setPermissionState in try/catch"
      pattern: "setPermissionState.*setIsLoading\\(false\\)"
---

<objective>
Add loading state to permission detection to prevent race condition where UI renders before permission state is known.

Purpose: Fixes the race condition in Window Management API permission detection. The current hook initializes permissionState to 'unavailable' and updates it asynchronously, causing the PermissionExplainer to either not appear or flash incorrectly. This phase ensures permission state is definitively known before any UI decisions are made.

Output: Updated useWindowManagement hook with isLoading boolean, and PresentationView that shows "Checking displays..." during loading and defers permission UI until state is known.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/v1.2-01-permission-state-loading/01-RESEARCH.md
@hooks/useWindowManagement.ts
@components/PresentationView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isLoading state to useWindowManagement hook</name>
  <files>hooks/useWindowManagement.ts</files>
  <action>
Modify the useWindowManagement hook to track loading state:

1. Add `isLoading: boolean` to UseWindowManagementResult interface (line 18-29):
   ```typescript
   export interface UseWindowManagementResult {
     // ... existing fields ...
     /** True until initial permission check completes */
     isLoading: boolean;
   }
   ```

2. Add isLoading state in the hook (after line 67, with other state):
   ```typescript
   const [isLoading, setIsLoading] = useState(true);
   ```

3. Update the "Initial detection" useEffect (lines 76-106) to set isLoading = false when API not supported:
   - After `setPermissionState('unavailable')` on line 78-79, add `setIsLoading(false)`
   - After `setPermissionState('unavailable')` on line 89, add `setIsLoading(false)`

4. Update the "Check existing permission" useEffect (lines 109-147) to set isLoading = false after permission check:
   - After `setPermissionState(permissionStatus.state ...)` on line 122, add `setIsLoading(false)`
   - In the catch block after `setPermissionState('prompt')` on line 136, add `setIsLoading(false)`
   - IMPORTANT: Also handle the early return case - if `!isSupported || !hasMultipleScreens`, the loading is already complete from the previous effect, so no change needed there.

5. Add isLoading to the return object (line 269-275):
   ```typescript
   return {
     isSupported,
     hasMultipleScreens,
     permissionState,
     secondaryScreen,
     requestPermission,
     isLoading
   };
   ```

Key patterns from research:
- isLoading starts as `true` (safe default)
- isLoading becomes `false` ONLY after async permission check resolves
- The mounted check pattern (mountedRef) is already in place - use it
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>useWindowManagement hook exports isLoading boolean that starts true and becomes false after permission state is definitively known</done>
</task>

<task type="auto">
  <name>Task 2: Update PresentationView to use isLoading</name>
  <files>components/PresentationView.tsx</files>
  <action>
Update PresentationView to check isLoading before rendering permission-dependent UI:

1. Destructure isLoading from the hook (lines 225-231):
   ```typescript
   const {
     isSupported,
     hasMultipleScreens,
     permissionState,
     secondaryScreen,
     requestPermission,
     isLoading  // ADD THIS
   } = useWindowManagement();
   ```

2. Update the PermissionExplainer useEffect (lines 243-247) to wait for loading:
   ```typescript
   useEffect(() => {
     // Only show explainer when NOT loading AND state is definitively 'prompt'
     if (!isLoading && isSupported && hasMultipleScreens && permissionState === 'prompt') {
       setShowPermissionExplainer(true);
     }
   }, [isLoading, isSupported, hasMultipleScreens, permissionState]);
   ```

3. Update the launch button (lines 439-476) to show loading state:
   - Change the disabled condition to include isLoading: `disabled={isLoading || isConnected}`
   - Update the button label logic to show "Checking displays..." when loading:
   ```typescript
   {isLoading
     ? 'Checking displays...'
     : secondaryScreen
       ? `Launch on ${secondaryScreen.label}`
       : isConnected
         ? 'Student Active'
         : 'Launch Student'}
   ```

4. Gate permission-dependent UI on !isLoading:
   - The PermissionExplainer (lines 478-486) is already gated by showPermissionExplainer state, which is now gated by !isLoading in the useEffect
   - The ManualPlacementGuide (lines 489-493) should also wait for loading. Update the condition:
   ```typescript
   {!isLoading && hasMultipleScreens && (!isSupported || permissionState === 'denied') && !isConnected && !popupBlocked && (
   ```

The key insight: During loading, the button shows "Checking displays..." and is disabled. No permission UI (PermissionExplainer or ManualPlacementGuide) appears until isLoading is false.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Manual test: Load the app in Chrome with multiple monitors. The button should briefly show "Checking displays..." then switch to either "Launch on [Display Name]" or "Launch Student" depending on permission state.
  </verify>
  <done>
- Launch button shows "Checking displays..." during loading and is disabled
- PermissionExplainer only appears when isLoading is false AND permissionState is 'prompt'
- ManualPlacementGuide only appears when isLoading is false AND conditions are met
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **TypeScript compilation:** `npx tsc --noEmit` passes without errors

2. **Behavioral verification (manual):**
   - Open app in Chrome on a multi-monitor setup
   - Observe button shows "Checking displays..." briefly on load
   - After loading completes:
     - If permission is 'granted': Button shows "Launch on [Display Name]"
     - If permission is 'prompt': Button shows "Launch Student" AND PermissionExplainer appears
     - If permission is 'denied': Button shows "Launch Student" AND ManualPlacementGuide appears
   - PermissionExplainer never flashes or appears incorrectly during initial load

3. **Edge cases:**
   - Single monitor: Loading completes quickly, no permission UI shown
   - Non-Chromium browser: Loading completes quickly, shows ManualPlacementGuide if multiple monitors
</verification>

<success_criteria>
- [x] isLoading exported from useWindowManagement hook
- [x] isLoading starts true, becomes false only after async permission check
- [x] Launch button shows "Checking displays..." during loading
- [x] Launch button is disabled during loading
- [x] PermissionExplainer waits for !isLoading before appearing
- [x] ManualPlacementGuide waits for !isLoading before appearing
- [x] No flashing or incorrect UI during initial render
</success_criteria>

<output>
After completion, create `.planning/phases/v1.2-01-permission-state-loading/01-01-SUMMARY.md`
</output>
