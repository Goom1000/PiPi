---
phase: 36-core-ask-ai
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/aiProvider.ts
  - types.ts
autonomous: true

must_haves:
  truths:
    - "ChatContext type exists with lessonTopic, currentSlideTitle, currentSlideContent, cumulativeContent, gradeLevel fields"
    - "AIProviderInterface has streamChat method returning AsyncGenerator<string>"
    - "buildChatContext helper constructs context from slides and current index"
  artifacts:
    - path: "services/aiProvider.ts"
      provides: "ChatContext interface, streamChat method signature, buildChatContext helper"
      exports: ["ChatContext", "buildChatContext"]
    - path: "types.ts"
      provides: "No changes needed - uses existing Slide type"
  key_links:
    - from: "services/aiProvider.ts"
      to: "AIProviderInterface"
      via: "streamChat method added to interface"
      pattern: "streamChat.*AsyncGenerator"
---

<objective>
Define the streaming chat interface and context structure for Ask AI feature.

Purpose: Establish the provider-agnostic contract that both Gemini and Claude providers will implement. The streamChat method returns an async generator for streaming text chunks.

Output: Extended AIProviderInterface with streamChat method, ChatContext type for lesson context, and buildChatContext helper function.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-core-ask-ai/36-RESEARCH.md

@services/aiProvider.ts
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ChatContext type and buildChatContext helper</name>
  <files>services/aiProvider.ts</files>
  <action>
Add ChatContext interface after existing SlideContext interface:

```typescript
// Context for Ask AI chat feature
export interface ChatContext {
  lessonTopic: string;           // From first slide title
  currentSlideTitle: string;     // Current slide title
  currentSlideContent: string[]; // Current slide bullets
  cumulativeContent: string;     // All slides up to current, formatted
  gradeLevel: string;            // For age-appropriate responses (e.g., "Year 6", "10-11 years old")
}
```

Add buildChatContext helper function (similar pattern to existing buildSlideContext):

```typescript
// Helper to build chat context for Ask AI feature
export function buildChatContext(
  slides: Slide[],
  currentIndex: number,
  gradeLevel: string
): ChatContext {
  const relevantSlides = slides.slice(0, currentIndex + 1);
  const cumulativeContent = relevantSlides
    .map((s, i) => `Slide ${i + 1} (${s.title}): ${s.content.join('; ')}`)
    .join('\n\n');

  return {
    lessonTopic: slides[0]?.title || 'Unknown Topic',
    currentSlideTitle: slides[currentIndex]?.title || 'Current Slide',
    currentSlideContent: slides[currentIndex]?.content || [],
    cumulativeContent,
    gradeLevel,
  };
}
```

Export ChatContext and buildChatContext from the module.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit
```
  </verify>
  <done>ChatContext interface and buildChatContext helper exist in aiProvider.ts and are exported.</done>
</task>

<task type="auto">
  <name>Task 2: Add streamChat method to AIProviderInterface</name>
  <files>services/aiProvider.ts</files>
  <action>
Add streamChat method to AIProviderInterface (after regenerateTeleprompter):

```typescript
  // Ask AI: streaming chat response
  streamChat(
    message: string,
    context: ChatContext
  ): AsyncGenerator<string, void, unknown>;
```

This method:
- Takes user message and lesson context
- Returns an async generator that yields text chunks
- Each chunk is a string fragment of the response
- Generator completes when response is fully streamed

Do NOT implement the method in providers yet - just add the interface signature. The providers will be implemented in Plans 02 and 03.

Note: Since TypeScript interfaces can define async generators, no special handling needed. Providers will implement using `async function*` syntax.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit
```

Confirm interface has streamChat method (may show errors for providers not implementing yet - that's expected):
```bash
grep -n "streamChat" services/aiProvider.ts
```
  </verify>
  <done>AIProviderInterface includes streamChat method signature returning AsyncGenerator&lt;string&gt;.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. TypeScript compilation succeeds (aside from provider implementation errors expected until Plans 02-03):
   ```bash
   npx tsc --noEmit 2>&1 | head -20
   ```

2. ChatContext type is exported:
   ```bash
   grep -n "export.*ChatContext" services/aiProvider.ts
   ```

3. buildChatContext function is exported:
   ```bash
   grep -n "export function buildChatContext" services/aiProvider.ts
   ```

4. streamChat in interface:
   ```bash
   grep -n "streamChat" services/aiProvider.ts
   ```
</verification>

<success_criteria>
- ChatContext interface defined with all 5 fields (lessonTopic, currentSlideTitle, currentSlideContent, cumulativeContent, gradeLevel)
- buildChatContext helper function constructs context from slides array
- AIProviderInterface extended with streamChat method
- Both new exports are properly typed
- TypeScript compiles (provider errors expected until Plans 02-03)
</success_criteria>

<output>
After completion, create `.planning/phases/36-core-ask-ai/36-01-SUMMARY.md`
</output>
