---
phase: 36-core-ask-ai
plan: 04
type: execute
wave: 3
depends_on: ["36-02", "36-03"]
files_modified:
  - components/PresentationView.tsx
autonomous: false

must_haves:
  truths:
    - "Teacher can type question in input field within teleprompter panel"
    - "Thinking... indicator shows while waiting for first chunk"
    - "Response streams character-by-character with smooth animation"
    - "Quick action buttons populate input with preset prompts"
    - "Copy button copies response, shows Copied feedback"
    - "Errors show friendly message with Try again button"
    - "Privacy indicator shows Not visible to students"
    - "Arrow keys still navigate slides when input focused"
    - "Student view shows no trace of assistant"
  artifacts:
    - path: "components/PresentationView.tsx"
      provides: "Ask AI panel UI with input, streaming display, quick actions, copy, error handling"
  key_links:
    - from: "components/PresentationView.tsx"
      to: "services/aiProvider.ts"
      via: "provider.streamChat and buildChatContext"
      pattern: "provider\\.streamChat|buildChatContext"
    - from: "components/PresentationView.tsx"
      to: "navigator.clipboard"
      via: "clipboard.writeText for copy"
      pattern: "navigator\\.clipboard"
---

<objective>
Build the Ask AI panel UI in PresentationView with streaming display, quick actions, and error handling.

Purpose: Provide teachers with an inline AI assistant they can query during presentations. The panel appears in the teleprompter area with text input, streaming responses, quick action buttons, copy functionality, and privacy indicator.

Output: Functional Ask AI panel integrated into PresentationView.tsx with all UI requirements met.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-core-ask-ai/36-RESEARCH.md
@.planning/phases/36-core-ask-ai/36-01-SUMMARY.md
@.planning/phases/36-core-ask-ai/36-02-SUMMARY.md
@.planning/phases/36-core-ask-ai/36-03-SUMMARY.md

@components/PresentationView.tsx
@services/aiProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Ask AI state and streaming logic</name>
  <files>components/PresentationView.tsx</files>
  <action>
Add imports at the top of the file:
```typescript
import { buildChatContext, ChatContext } from '../services/aiProvider';
```

Add state variables after the existing state declarations (around line 140-150):
```typescript
// Ask AI state
const [askAIInput, setAskAIInput] = useState('');
const [askAIResponse, setAskAIResponse] = useState('');
const [askAIDisplayedText, setAskAIDisplayedText] = useState('');
const [askAIIsLoading, setAskAIIsLoading] = useState(false);
const [askAIIsStreaming, setAskAIIsStreaming] = useState(false);
const [askAIError, setAskAIError] = useState<string | null>(null);
const askAIAbortRef = useRef<AbortController | null>(null);
const askAIAnimationRef = useRef<number | null>(null);
const askAIMountedRef = useRef(true);
```

Add cleanup effect:
```typescript
// Ask AI cleanup on unmount
useEffect(() => {
  askAIMountedRef.current = true;
  return () => {
    askAIMountedRef.current = false;
    askAIAbortRef.current?.abort();
    if (askAIAnimationRef.current) {
      cancelAnimationFrame(askAIAnimationRef.current);
    }
  };
}, []);
```

Add animation effect for smooth character-by-character display (dual-state pattern from research):
```typescript
// Ask AI text animation - displays text character by character
useEffect(() => {
  if (askAIResponse.length === 0) return;

  let charIndex = askAIDisplayedText.length;
  let lastTime = performance.now();

  const animate = (currentTime: number) => {
    if (!askAIMountedRef.current) return;

    const elapsed = currentTime - lastTime;
    const charsToAdd = Math.floor(elapsed / 5); // 5ms per character = 200 chars/sec

    if (charsToAdd > 0 && charIndex < askAIResponse.length) {
      charIndex = Math.min(charIndex + charsToAdd, askAIResponse.length);
      setAskAIDisplayedText(askAIResponse.slice(0, charIndex));
      lastTime = currentTime;
    }

    if (charIndex < askAIResponse.length) {
      askAIAnimationRef.current = requestAnimationFrame(animate);
    }
  };

  askAIAnimationRef.current = requestAnimationFrame(animate);

  return () => {
    if (askAIAnimationRef.current) {
      cancelAnimationFrame(askAIAnimationRef.current);
    }
  };
}, [askAIResponse]);
```

Add handler functions:
```typescript
// Ask AI: Send message and stream response
const handleAskAISend = useCallback(async () => {
  if (!provider || !askAIInput.trim()) return;

  // Abort any existing request
  askAIAbortRef.current?.abort();
  askAIAbortRef.current = new AbortController();

  const message = askAIInput.trim();
  setAskAIInput('');
  setAskAIResponse('');
  setAskAIDisplayedText('');
  setAskAIError(null);
  setAskAIIsLoading(true);
  setAskAIIsStreaming(true);

  try {
    // Use "Year 6" as default grade level - adjust based on your app's needs
    // In future, this could come from lesson metadata
    const context = buildChatContext(slides, currentIndex, 'Year 6 (10-11 years old)');
    const stream = provider.streamChat(message, context);

    let fullResponse = '';
    let firstChunk = true;

    for await (const chunk of stream) {
      if (!askAIMountedRef.current) break;

      if (firstChunk) {
        setAskAIIsLoading(false);
        firstChunk = false;
      }

      fullResponse += chunk;
      setAskAIResponse(fullResponse);
    }
  } catch (e) {
    if (!askAIMountedRef.current) return;

    if (e instanceof AIProviderError) {
      setAskAIError(e.userMessage);
    } else if ((e as Error).name !== 'AbortError') {
      setAskAIError('Something went wrong. Please try again.');
    }
  } finally {
    if (askAIMountedRef.current) {
      setAskAIIsLoading(false);
      setAskAIIsStreaming(false);
    }
  }
}, [provider, askAIInput, slides, currentIndex]);

// Ask AI: Retry last message
const handleAskAIRetry = useCallback(() => {
  // Retry with same input
  handleAskAISend();
}, [handleAskAISend]);

// Ask AI: Copy response to clipboard
const handleAskAICopy = useCallback(async () => {
  if (!askAIResponse) return;

  try {
    await navigator.clipboard.writeText(askAIResponse);
    addToast('Copied to clipboard', 2000, 'success');
  } catch {
    addToast('Failed to copy', 2000, 'error');
  }
}, [askAIResponse, addToast]);

// Ask AI: Clear response
const handleAskAIClear = useCallback(() => {
  askAIAbortRef.current?.abort();
  setAskAIResponse('');
  setAskAIDisplayedText('');
  setAskAIError(null);
  setAskAIIsLoading(false);
  setAskAIIsStreaming(false);
}, []);
```

Quick action prompts constant (place near top of file with other constants):
```typescript
const QUICK_ACTIONS = [
  { label: 'Get 3 facts', prompt: 'Give me 3 interesting facts about this topic that students would find engaging.' },
  { label: 'Explain simply', prompt: 'Explain this concept in simpler terms suitable for the students.' },
  { label: 'Answer question', prompt: 'A student asked about this. How should I answer?' },
] as const;
```
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit 2>&1 | head -20
```

State variables added:
```bash
grep -n "askAI" components/PresentationView.tsx | head -15
```
  </verify>
  <done>Ask AI state, streaming logic, handlers, and animation effect added to PresentationView.tsx.</done>
</task>

<task type="auto">
  <name>Task 2: Add Ask AI panel UI</name>
  <files>components/PresentationView.tsx</files>
  <action>
Add the Ask AI panel UI inside the teleprompter panel section. Find the teleprompter panel div (the one with "Presenter Console" header, around line 1480-1540).

Add the Ask AI panel AFTER the script display div and BEFORE the button area. Place it in the scrollable content area or as a collapsible section.

Insert this JSX after the script segment display (after the MarkdownText component, around line 1535):

```tsx
{/* Ask AI Panel - Teacher only (not synced to student view) */}
{isAIAvailable && (
  <div className="mt-4 pt-4 border-t border-slate-700/50">
    {/* Privacy Indicator */}
    <div className="flex items-center gap-1.5 mb-3">
      <svg className="w-3 h-3 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
      </svg>
      <span className="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Not visible to students</span>
    </div>

    {/* Quick Action Buttons */}
    <div className="flex flex-wrap gap-1.5 mb-3">
      {QUICK_ACTIONS.map((action) => (
        <button
          key={action.label}
          onClick={() => setAskAIInput(action.prompt)}
          disabled={askAIIsLoading || askAIIsStreaming}
          className="px-2 py-1 text-[10px] font-medium bg-slate-700/50 hover:bg-slate-600 text-slate-300 hover:text-white rounded-lg transition-colors disabled:opacity-50"
        >
          {action.label}
        </button>
      ))}
    </div>

    {/* Input Field */}
    <div className="flex gap-2 mb-3">
      <input
        type="text"
        value={askAIInput}
        onChange={(e) => setAskAIInput(e.target.value)}
        onKeyDown={(e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleAskAISend();
          }
          // Allow arrow keys to bubble up for slide navigation
          if (e.key === 'ArrowLeft' || e.key === 'ArrowRight' ||
              e.key === 'ArrowUp' || e.key === 'ArrowDown' ||
              e.key === 'PageUp' || e.key === 'PageDown') {
            e.currentTarget.blur();
          }
        }}
        placeholder="Ask AI anything about this lesson..."
        disabled={askAIIsLoading || askAIIsStreaming}
        className="flex-1 px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-sm text-white placeholder-slate-400 focus:outline-none focus:border-indigo-500 disabled:opacity-50"
      />
      <button
        onClick={handleAskAISend}
        disabled={!askAIInput.trim() || askAIIsLoading || askAIIsStreaming}
        className="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-600 disabled:opacity-50 text-white text-sm font-medium rounded-lg transition-colors"
      >
        Send
      </button>
    </div>

    {/* Loading Indicator */}
    {askAIIsLoading && (
      <div className="flex items-center gap-2 text-slate-400 text-sm mb-3">
        <div className="w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin" />
        <span>Thinking...</span>
      </div>
    )}

    {/* Error Display */}
    {askAIError && (
      <div className="bg-red-900/30 border border-red-700/50 rounded-lg p-3 mb-3">
        <p className="text-red-300 text-sm mb-2">{askAIError}</p>
        <button
          onClick={handleAskAIRetry}
          className="text-red-400 hover:text-red-300 text-sm font-medium underline"
        >
          Try again
        </button>
      </div>
    )}

    {/* Response Display */}
    {askAIDisplayedText && !askAIError && (
      <div className="bg-slate-800/50 rounded-lg p-3">
        <p className="text-slate-200 text-sm leading-relaxed whitespace-pre-wrap">
          {askAIDisplayedText}
          {askAIIsStreaming && <span className="inline-block w-2 h-4 bg-indigo-400 ml-0.5 animate-pulse" />}
        </p>

        {/* Copy Button - only show when response is complete */}
        {!askAIIsStreaming && (
          <div className="flex justify-end mt-2 pt-2 border-t border-slate-700/50">
            <button
              onClick={handleAskAICopy}
              className="flex items-center gap-1.5 px-2 py-1 text-[10px] font-medium text-slate-400 hover:text-white transition-colors"
            >
              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              Copy
            </button>
            <button
              onClick={handleAskAIClear}
              className="flex items-center gap-1.5 px-2 py-1 text-[10px] font-medium text-slate-400 hover:text-white transition-colors ml-2"
            >
              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
              Clear
            </button>
          </div>
        )}
      </div>
    )}
  </div>
)}
```

Important placement notes:
- The panel must be INSIDE the teleprompter panel's scrollable area (the div with className containing "overflow-y-auto")
- It should NOT be synced to student view - it's pure local state
- The isAIAvailable check hides panel when no API key configured
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit 2>&1 | head -10
```

Ask AI UI present:
```bash
grep -n "Ask AI" components/PresentationView.tsx
grep -n "Not visible to students" components/PresentationView.tsx
```

Quick actions present:
```bash
grep -n "QUICK_ACTIONS" components/PresentationView.tsx
```
  </verify>
  <done>Ask AI panel UI added to PresentationView with input, streaming display, quick actions, copy button, error handling, and privacy indicator.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Ask AI feature in the teleprompter panel with:
- Text input field
- Send button (Enter key also works)
- Quick action buttons (Get 3 facts, Explain simply, Answer question)
- "Thinking..." loading indicator
- Streaming character-by-character response display
- Copy button (appears when response complete)
- Error display with "Try again" button
- "Not visible to students" privacy indicator
- Arrow keys blur input to preserve slide navigation
  </what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Upload a PDF or load a .cue file
3. Enter presentation mode
4. In the teleprompter panel (right side), find the "Ask AI" section below the script
5. Verify the privacy indicator "Not visible to students" is visible
6. Click a quick action button - input field should populate
7. Type a question and press Enter or click Send
8. Watch for "Thinking..." indicator (should appear within 200ms)
9. Watch response stream character-by-character (smooth, not chunky)
10. When complete, click Copy - verify toast shows "Copied to clipboard"
11. Test arrow keys while input is focused - should blur and navigate slides
12. Open student window - verify NO Ask AI content is visible
13. Test error: Enter invalid API key in settings, try to send - verify error with "Try again"
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Manual verification via the checkpoint above. Additionally:

1. TypeScript compiles without errors:
   ```bash
   npx tsc --noEmit
   ```

2. Dev server runs:
   ```bash
   npm run dev
   ```

3. No console errors during Ask AI usage

4. Response character animation is smooth (not jerky)
</verification>

<success_criteria>
- CHAT-01: Text input field visible in teleprompter panel
- CHAT-02: Response streams character-by-character (smooth animation)
- CHAT-03: "Thinking..." indicator shows while waiting
- CHAT-04: Copy button works, shows "Copied" toast
- CHAT-05: Errors show friendly message with "Try again" button
- CTXT-03: Quick action buttons populate input
- UX-01: Panel is inline (not modal), doesn't steal focus
- UX-02: No Ask AI state synced to student view (local only)
- UX-03: "Not visible to students" indicator visible
- Arrow keys blur input and navigate slides
</success_criteria>

<output>
After completion, create `.planning/phases/36-core-ask-ai/36-04-SUMMARY.md`
</output>
