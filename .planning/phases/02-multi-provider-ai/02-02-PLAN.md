---
phase: 02-multi-provider-ai
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - services/providers/claudeProvider.ts
autonomous: true

must_haves:
  truths:
    - "Claude provider makes real API calls to Anthropic"
    - "Browser CORS header is included in all requests"
    - "All 9 interface methods are implemented"
    - "Error responses are mapped to AIProviderError with correct codes"
    - "JSON responses are parsed and normalized to match Gemini output format"
  artifacts:
    - path: "services/providers/claudeProvider.ts"
      provides: "Full Claude provider implementation"
      min_lines: 200
  key_links:
    - from: "services/providers/claudeProvider.ts"
      to: "https://api.anthropic.com/v1/messages"
      via: "fetch with CORS header"
      pattern: "anthropic-dangerous-direct-browser-access.*true"
---

<objective>
Implement the Claude provider with full functionality matching Gemini's capabilities.

Purpose: Enable users who prefer Claude to generate slides with the same quality as Gemini. This is the primary alternative provider since OpenAI doesn't support browser CORS.

Output: Fully functional `services/providers/claudeProvider.ts` that can generate slides, images, quizzes, etc.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-multi-provider-ai/02-CONTEXT.md
@.planning/phases/02-multi-provider-ai/02-RESEARCH.md
@.planning/phases/02-multi-provider-ai/02-01-SUMMARY.md (after Plan 1 completes)

Key reference:
@services/geminiService.ts (prompts to adapt)
@services/providers/geminiProvider.ts (interface reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Claude API helper and error mapping</name>
  <files>services/providers/claudeProvider.ts</files>
  <action>
Replace the placeholder claudeProvider.ts with a real implementation.

**1. Add imports:**
```typescript
import { AIProviderInterface, AIProviderError, AIErrorCode, USER_ERROR_MESSAGES } from '../aiProvider';
import { Slide, LessonResource } from '../../types';
import { QuizQuestion } from '../geminiService';
```

**2. Create helper function for Claude API calls:**
```typescript
interface ClaudeMessage {
  role: 'user' | 'assistant';
  content: string | ClaudeContentBlock[];
}

interface ClaudeContentBlock {
  type: 'text' | 'image';
  text?: string;
  source?: { type: 'base64'; media_type: string; data: string };
}

async function callClaude(
  apiKey: string,
  messages: ClaudeMessage[],
  systemPrompt: string,
  maxTokens: number = 4096
): Promise<string> {
  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'content-type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true',  // REQUIRED for browser
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-5-20250929',
      max_tokens: maxTokens,
      system: systemPrompt,
      messages,
    }),
  });

  if (!response.ok) {
    const errorBody = await response.json().catch(() => ({}));
    const code = mapHttpToErrorCode(response.status, errorBody);
    throw new AIProviderError(USER_ERROR_MESSAGES[code], code, errorBody);
  }

  const data = await response.json();
  return data.content?.[0]?.text || '';
}
```

**3. Create error mapping function:**
```typescript
function mapHttpToErrorCode(status: number, body: any): AIErrorCode {
  if (status === 429) {
    const msg = (body?.error?.message || '').toLowerCase();
    if (msg.includes('quota') || msg.includes('billing') || msg.includes('insufficient')) {
      return 'QUOTA_EXCEEDED';
    }
    return 'RATE_LIMIT';
  }
  if (status === 401 || status === 403) return 'AUTH_ERROR';
  if (status >= 500 || status === 529) return 'SERVER_ERROR';
  return 'UNKNOWN_ERROR';
}
```

**4. Create JSON extraction helper:**
```typescript
function extractJSON<T>(text: string): T {
  // Claude sometimes wraps JSON in markdown code blocks
  const jsonMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/) || [null, text];
  const jsonStr = jsonMatch[1]?.trim() || text.trim();

  try {
    return JSON.parse(jsonStr);
  } catch (e) {
    throw new AIProviderError(USER_ERROR_MESSAGES.PARSE_ERROR, 'PARSE_ERROR', e);
  }
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>callClaude helper function exists with proper CORS header and error mapping</done>
</task>

<task type="auto">
  <name>Task 2: Implement all 9 provider methods</name>
  <files>services/providers/claudeProvider.ts</files>
  <action>
Implement all methods in ClaudeProvider class. Adapt prompts from geminiService.ts.

**Key differences from Gemini:**
- Claude uses text prompts, not structured output schema
- Must explicitly request JSON output format in prompt
- Image generation not supported by Claude API - return undefined
- Vision capability uses base64 images in content blocks

**1. generateLessonSlides:**
- Adapt system prompt from geminiService
- Add "Return your response as a JSON array" instruction
- Handle pageImages by converting to ClaudeContentBlock with base64
- Parse response with extractJSON

**2. generateSlideImage:**
- Claude doesn't generate images
- Return `undefined` (app will show placeholder or skip)

**3. generateResourceImage:**
- Return `undefined` (same as above)

**4. generateQuickQuestion:**
- Adapt prompt, request plain text response
- Return text directly

**5. reviseSlide:**
- Send current slide JSON + instruction
- Request partial JSON response
- Parse and return

**6. generateContextualSlide:**
- Adapt prompt with context about surrounding slides
- Request full slide JSON
- Add id and isGeneratingImage fields to result

**7. generateExemplarSlide:**
- Adapt the exemplar prompt from geminiService
- Request JSON response
- Add id and isGeneratingImage fields

**8. generateLessonResources:**
- Adapt resource generation prompt
- Request JSON array response
- Add id fields to each resource

**9. generateImpromptuQuiz:**
- Adapt quiz prompt
- Request JSON array of questions
- Parse and return

**Implementation pattern for each method:**
```typescript
async generateLessonSlides(rawText: string, pageImages?: string[]): Promise<Slide[]> {
  const systemPrompt = `[adapted from geminiService]

  IMPORTANT: Return your response as a valid JSON array. Do not include any text before or after the JSON.`;

  const content: ClaudeContentBlock[] = [
    { type: 'text', text: `Transform this lesson plan into slides: ${rawText}` }
  ];

  // Add images if provided
  pageImages?.forEach(base64 => {
    const data = base64.includes(',') ? base64.split(',')[1] : base64;
    content.push({
      type: 'image',
      source: { type: 'base64', media_type: 'image/jpeg', data }
    });
  });

  const response = await callClaude(
    this.apiKey,
    [{ role: 'user', content }],
    systemPrompt,
    8192  // Higher token limit for lesson slides
  );

  const slides = extractJSON<any[]>(response);
  return slides.map((item, index) => ({
    ...item,
    id: `slide-${Date.now()}-${index}`,
    isGeneratingImage: false
  }));
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>All 9 methods implemented with proper prompts, error handling, and response parsing</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Compile check**: `npx tsc --noEmit` passes
2. **Method count**: ClaudeProvider has all 9 methods matching interface
3. **CORS header**: grep confirms `anthropic-dangerous-direct-browser-access` is present
4. **Error handling**: All API calls wrapped with proper error mapping
5. **Image methods**: generateSlideImage and generateResourceImage return undefined (not throw)
</verification>

<success_criteria>
1. ClaudeProvider fully implements AIProviderInterface
2. All text generation methods (7 of 9) make real API calls to Anthropic
3. Image generation methods return undefined gracefully
4. Error responses properly mapped to AIProviderError codes
5. JSON responses extracted and normalized to match expected types
6. Browser CORS header included in all requests
7. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-multi-provider-ai/02-02-SUMMARY.md`
</output>
