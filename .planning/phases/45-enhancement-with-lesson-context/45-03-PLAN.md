---
phase: 45-enhancement-with-lesson-context
plan: 03
type: execute
wave: 3
depends_on: ["45-02"]
files_modified:
  - components/EnhancementPanel.tsx
  - components/ResourceHub.tsx
autonomous: false

must_haves:
  truths:
    - "User can see matched slides before enhancement begins"
    - "User can cancel enhancement while processing"
    - "User can see three differentiation levels after enhancement"
    - "User can regenerate enhancement if unhappy"
  artifacts:
    - path: "components/EnhancementPanel.tsx"
      provides: "Enhancement configuration, progress, and results UI"
      exports: ["EnhancementPanel"]
    - path: "components/ResourceHub.tsx"
      provides: "Integration point for enhancement flow"
      contains: "EnhancementPanel"
  key_links:
    - from: "components/EnhancementPanel.tsx"
      to: "services/documentEnhancement/documentEnhancementService.ts"
      via: "enhanceUploadedDocument call"
      pattern: "enhanceUploadedDocument"
    - from: "components/ResourceHub.tsx"
      to: "components/EnhancementPanel.tsx"
      via: "component import"
      pattern: "import.*EnhancementPanel"
---

<objective>
Build the UI for document enhancement: slide matching confirmation, progress display with cancel, and results view showing three differentiation levels.

Purpose: Enable teachers to review detected slide matches, trigger enhancement, monitor progress with ability to cancel, and view/select from three differentiation levels plus answer keys. This completes the enhancement flow from upload to enhanced output.

Output: EnhancementPanel component integrated into ResourceHub, showing matched slides, enhance button, progress with cancel, and tabbed results view.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-enhancement-with-lesson-context/45-CONTEXT.md
@.planning/phases/45-enhancement-with-lesson-context/45-RESEARCH.md
@.planning/phases/45-enhancement-with-lesson-context/45-01-SUMMARY.md
@.planning/phases/45-enhancement-with-lesson-context/45-02-SUMMARY.md
@types.ts
@services/documentEnhancement/documentEnhancementService.ts
@components/ResourceHub.tsx
@components/UploadPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EnhancementPanel component</name>
  <files>components/EnhancementPanel.tsx</files>
  <action>
Create new file `components/EnhancementPanel.tsx`:

1. Props interface:
```typescript
interface EnhancementPanelProps {
  resource: UploadedResource;
  analysis: DocumentAnalysis;
  slides: Slide[];
  provider: AIProviderInterface;
  onError: (title: string, message: string) => void;
}
```

2. State management:
   - enhancementState: EnhancementState (from documentEnhancementService)
   - result: EnhancementResult | null
   - selectedLevel: 'simple' | 'standard' | 'detailed' (default 'standard')
   - showAnswerKey: boolean
   - abortControllerRef: useRef<AbortController | null>

3. Slide Matching Section (shown when status === 'idle'):
   - Header: "This resource relates to these slides"
   - List matched slides (from analysis or initial AI detection)
   - For now, show placeholder: "AI will detect relevant slides during enhancement"
   - "Enhance" button (primary, full-width)
   - Note: Slide matching happens during enhancement, not before (simplifies flow per Claude's discretion)

4. Progress Section (shown when status === 'enhancing'):
   - Simple progress bar (indeterminate or percentage based on state.progress)
   - Text: "Generating enhanced versions..."
   - Cancel button (secondary, visible throughout per CONTEXT.md)
   - handleCancel: abortControllerRef.current?.abort(), set state to 'cancelled'

5. Results Section (shown when status === 'complete'):
   - Matched Slides display:
     * List slideMatches from result
     * Format: "Slide N: Title" with relevance badge (high/medium/low)
   - Differentiation Tabs:
     * Three tabs: Simple | Standard | Detailed
     * Active tab shows selectedLevel content
     * Each tab badge shows slide alignment note
   - Content Preview:
     * Display elements from selected version
     * Preserve visual content markers as "[Original diagram: X]"
     * Show slideReference for each element if present
   - Answer Key Toggle:
     * Button to show/hide answer key
     * When visible, show AnswerKey items
     * For open-ended: show rubric criteria
   - Regenerate button (ENHANCE-06):
     * "Regenerate" button at bottom
     * Calls handleEnhance again (resets state, new AbortController)

6. Error Section (shown when status === 'error'):
   - Error message display
   - "Try Again" button

7. Cancelled Section (shown when status === 'cancelled'):
   - "Enhancement cancelled"
   - "Try Again" button

8. handleEnhance async function:
```typescript
const handleEnhance = async () => {
  abortControllerRef.current = new AbortController();
  try {
    const result = await enhanceUploadedDocument(
      resource,
      analysis,
      slides,
      provider,
      getDefaultEnhancementOptions(),
      abortControllerRef.current.signal,
      setEnhancementState
    );
    setResult(result);
  } catch (error) {
    if ((error as Error).name === 'AbortError') {
      // Cancellation handled by onProgress callback
      return;
    }
    // Error state handled by onProgress callback
  } finally {
    abortControllerRef.current = null;
  }
};
```

Style with Tailwind, consistent with existing components (UploadPanel, ResourceHub patterns).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>EnhancementPanel component created with all enhancement flow states and interactions</done>
</task>

<task type="auto">
  <name>Task 2: Integrate EnhancementPanel into ResourceHub</name>
  <files>components/ResourceHub.tsx</files>
  <action>
1. Add imports:
   - EnhancementPanel from './EnhancementPanel'
   - DocumentAnalysis from '../types'
   - analyzeUploadedDocument, AnalysisResult from '../services/documentAnalysis/documentAnalysisService'
   - Slide from '../types'

2. Add new props to ResourceHubProps:
   - slides: Slide[] (for enhancement context)

3. Add state for enhancement flow:
   - selectedUploadedResource: UploadedResource | null
   - resourceAnalysis: Map<string, DocumentAnalysis> (cache by resource.id)
   - isAnalyzing: boolean

4. Modify the uploaded resources grid (in sidebar) to:
   - Make each uploaded resource card clickable
   - On click: setSelectedUploadedResource(resource)
   - Show selected state (border highlight like generated resources)
   - If analysis not cached, trigger analyzeUploadedDocument

5. Add analysis trigger when resource selected:
```typescript
useEffect(() => {
  if (!selectedUploadedResource || !provider) return;
  if (resourceAnalysis.has(selectedUploadedResource.id)) return;

  const analyzeResource = async () => {
    setIsAnalyzing(true);
    try {
      // Note: originalFile not available after upload, but content is preserved
      // Analysis service handles this (uses content.images and content.text)
      const { analysis } = await analyzeUploadedDocument(
        selectedUploadedResource,
        provider
      );
      setResourceAnalysis(prev => new Map(prev).set(selectedUploadedResource.id, analysis));
    } catch (err) {
      onError('Analysis Failed', (err as Error).message);
    } finally {
      setIsAnalyzing(false);
    }
  };

  analyzeResource();
}, [selectedUploadedResource, provider, resourceAnalysis]);
```

6. Update preview area (right panel) to show EnhancementPanel when:
   - An uploaded resource is selected AND
   - Analysis is complete (cached in resourceAnalysis)

```tsx
{selectedUploadedResource && resourceAnalysis.has(selectedUploadedResource.id) ? (
  <EnhancementPanel
    resource={selectedUploadedResource}
    analysis={resourceAnalysis.get(selectedUploadedResource.id)!}
    slides={slides}
    provider={provider!}
    onError={onError}
  />
) : selectedUploadedResource && isAnalyzing ? (
  <div className="flex items-center justify-center h-full">
    <div className="text-center">
      <div className="animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-4" />
      <p className="text-slate-500">Analyzing document...</p>
    </div>
  </div>
) : selectedResource ? (
  // Existing generated resource preview
  ...
) : (
  // Empty state
  ...
)}
```

7. Add visual indicator on uploaded resource cards when selected or has analysis:
   - Checkmark badge when analysis complete
   - Spinner when analyzing
   - Click to view enhancement panel

8. Update the component to receive slides prop from parent (App.tsx will need to pass this).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>ResourceHub integrates EnhancementPanel with analysis caching and resource selection</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete enhancement UI flow:
1. Upload a document in ResourceHub
2. Click on uploaded resource to analyze it
3. EnhancementPanel shows with "Enhance" button
4. Click Enhance to generate 3 differentiation levels + answer key
5. Cancel button works during enhancement
6. Results show with tabs for Simple/Standard/Detailed
7. Answer key toggle shows marking criteria
8. Regenerate button allows re-running enhancement
  </what-built>
  <how-to-verify>
1. Open the app and navigate to the editor with some slides created
2. Open the Resource Hub (classroom resources button)
3. Upload a PDF or image document
4. Verify the uploaded resource appears in the sidebar grid
5. Click on the uploaded resource
6. Verify "Analyzing document..." spinner appears briefly
7. Verify EnhancementPanel appears with "Enhance" button
8. Click "Enhance" button
9. Verify progress indicator appears with "Cancel" button
10. (Optional) Click Cancel to verify cancellation works
11. Let enhancement complete
12. Verify three tabs appear: Simple | Standard | Detailed
13. Click each tab and verify different content appears
14. Click "Show Answer Key" toggle
15. Verify answer key content appears
16. Click "Regenerate" button
17. Verify enhancement restarts

Note: If API key not configured, verify appropriate error/lock icon shown
  </how-to-verify>
  <resume-signal>Type "approved" if flow works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. EnhancementPanel component renders all states (idle, enhancing, complete, error, cancelled)
2. Cancel button aborts enhancement request
3. Three differentiation tabs display correct content
4. Answer key toggle shows/hides answer content
5. Regenerate button restarts enhancement flow
6. ResourceHub integrates EnhancementPanel when uploaded resource selected
7. Analysis is cached per resource (not re-run on re-selection)
8. TypeScript compiles without errors
</verification>

<success_criteria>
- User can click uploaded resource to see enhancement panel (ENHANCE-01 flow start)
- User sees "Enhance" button and can trigger enhancement
- User sees progress with visible Cancel button (ENHANCE-05)
- User can cancel enhancement and return to pre-enhancement state (ENHANCE-05)
- User sees three differentiation levels after enhancement (ENHANCE-02)
- User sees slide alignment info on each version (ENHANCE-03)
- User can view answer key (ENHANCE-04)
- User can regenerate enhancement (ENHANCE-06)
- All requirements ENHANCE-01 through ENHANCE-06 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/45-enhancement-with-lesson-context/45-03-SUMMARY.md`
</output>
