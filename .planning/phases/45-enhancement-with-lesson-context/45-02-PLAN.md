---
phase: 45-enhancement-with-lesson-context
plan: 02
type: execute
wave: 2
depends_on: ["45-01"]
files_modified:
  - services/providers/geminiProvider.ts
  - services/providers/claudeProvider.ts
  - services/documentEnhancement/documentEnhancementService.ts
autonomous: true

must_haves:
  truths:
    - "Both AI providers can enhance documents with three differentiation levels"
    - "Enhancement can be cancelled mid-request"
    - "Enhancement service orchestrates the full pipeline"
  artifacts:
    - path: "services/providers/geminiProvider.ts"
      provides: "enhanceDocument implementation for Gemini"
      contains: "enhanceDocument"
    - path: "services/providers/claudeProvider.ts"
      provides: "enhanceDocument implementation for Claude"
      contains: "enhanceDocument"
    - path: "services/documentEnhancement/documentEnhancementService.ts"
      provides: "Enhancement orchestration with analysis + enhancement pipeline"
      exports: ["enhanceUploadedDocument"]
  key_links:
    - from: "services/documentEnhancement/documentEnhancementService.ts"
      to: "services/aiProvider.ts"
      via: "AIProviderInterface.enhanceDocument call"
      pattern: "provider\\.enhanceDocument"
    - from: "services/providers/geminiProvider.ts"
      to: "services/documentEnhancement/enhancementPrompts.ts"
      via: "prompt imports"
      pattern: "import.*enhancementPrompts"
---

<objective>
Implement AI provider enhancement methods and the orchestration service for document differentiation.

Purpose: Enable the actual AI-powered enhancement of documents with three differentiation levels, slide alignment detection, and answer key generation. Both Gemini and Claude providers will implement the `enhanceDocument` method with cancellation support.

Output: Working enhancement pipeline that accepts a DocumentAnalysis + slides, returns EnhancementResult with three versions and answer keys.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-enhancement-with-lesson-context/45-CONTEXT.md
@.planning/phases/45-enhancement-with-lesson-context/45-RESEARCH.md
@.planning/phases/45-enhancement-with-lesson-context/45-01-SUMMARY.md
@types.ts
@services/aiProvider.ts
@services/documentEnhancement/enhancementPrompts.ts
@services/providers/geminiProvider.ts
@services/providers/claudeProvider.ts
@services/documentAnalysis/documentAnalysisService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement enhanceDocument in Gemini provider</name>
  <files>services/providers/geminiProvider.ts</files>
  <action>
1. Add imports:
   - EnhancementResult, EnhancementOptions from '../../types'
   - ENHANCEMENT_SYSTEM_PROMPT, buildEnhancementUserPrompt from '../documentEnhancement/enhancementPrompts'

2. Create JSON schema constant `ENHANCEMENT_RESULT_SCHEMA` for structured output:
   - Type: object with properties matching EnhancementResult interface
   - slideMatches: array of SlideMatch objects
   - versions: object with simple/standard/detailed DifferentiatedVersion objects
   - answerKeys: AnswerKeyResult object
   - Use strict: true, additionalProperties: false

3. Implement `enhanceDocument` method:
```typescript
async enhanceDocument(
  documentAnalysis: DocumentAnalysis,
  slideContext: string,
  options: EnhancementOptions,
  signal?: AbortSignal
): Promise<EnhancementResult> {
  // Use GoogleGenAI SDK with structured output
  const ai = new GoogleGenAI({ apiKey: this.apiKey });

  const userPrompt = buildEnhancementUserPrompt(documentAnalysis, slideContext, options);

  const response = await ai.models.generateContent({
    model: 'gemini-2.0-flash',
    contents: { parts: [{ text: userPrompt }] },
    config: {
      systemInstruction: ENHANCEMENT_SYSTEM_PROMPT,
      responseMimeType: 'application/json',
      responseSchema: ENHANCEMENT_RESULT_SCHEMA,
      temperature: 0.3  // Some creativity for enhancements, but consistent
    }
  }, { signal });  // Pass abort signal for cancellation

  const text = response.text || '{}';
  return JSON.parse(text) as EnhancementResult;
}
```

4. Handle AbortError - let it propagate (caller handles cancellation)

Note: Use max_tokens equivalent of ~8192 to handle 3 versions + answer keys.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Gemini provider implements enhanceDocument with structured output and cancellation support</done>
</task>

<task type="auto">
  <name>Task 2: Implement enhanceDocument in Claude provider</name>
  <files>services/providers/claudeProvider.ts</files>
  <action>
1. Add imports:
   - EnhancementResult, EnhancementOptions from '../../types'
   - ENHANCEMENT_SYSTEM_PROMPT, buildEnhancementUserPrompt from '../documentEnhancement/enhancementPrompts'

2. Create JSON schema constant `ENHANCEMENT_RESULT_JSON_SCHEMA` for tool_choice:
   - Same structure as Gemini schema
   - Wrapped in tool format: { name: 'enhancement_result', input_schema: {...} }

3. Implement `enhanceDocument` method:
```typescript
async enhanceDocument(
  documentAnalysis: DocumentAnalysis,
  slideContext: string,
  options: EnhancementOptions,
  signal?: AbortSignal
): Promise<EnhancementResult> {
  const userPrompt = buildEnhancementUserPrompt(documentAnalysis, slideContext, options);

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': this.apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true',
    },
    body: JSON.stringify({
      model: MODEL,
      max_tokens: 8192,  // Enhancement output is substantial
      system: ENHANCEMENT_SYSTEM_PROMPT,
      messages: [{ role: 'user', content: userPrompt }],
      tools: [{
        name: 'enhancement_result',
        description: 'Return the enhancement result with differentiated versions',
        input_schema: ENHANCEMENT_RESULT_JSON_SCHEMA.schema
      }],
      tool_choice: { type: 'tool', name: 'enhancement_result' }
    }),
    signal  // Pass abort signal for cancellation
  });

  if (!response.ok) {
    throw this.createErrorFromResponse(response.status, await response.text());
  }

  const data = await response.json();
  const toolUse = data.content?.find((c: any) => c.type === 'tool_use');
  if (!toolUse?.input) {
    throw new AIProviderError(USER_ERROR_MESSAGES.PARSE_ERROR, 'PARSE_ERROR', 'No tool result');
  }
  return toolUse.input as EnhancementResult;
}
```

4. Reuse existing error handling helpers (getErrorMessage, getErrorCode, createErrorFromResponse)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Claude provider implements enhanceDocument with tool_choice and cancellation support</done>
</task>

<task type="auto">
  <name>Task 3: Create enhancement orchestration service</name>
  <files>services/documentEnhancement/documentEnhancementService.ts</files>
  <action>
Create new file `services/documentEnhancement/documentEnhancementService.ts`:

1. Import types and dependencies:
   - UploadedResource, DocumentAnalysis, EnhancementResult, EnhancementOptions, Slide from '../../types'
   - AIProviderInterface, buildSlideContextForEnhancement from '../aiProvider'
   - analyzeUploadedDocument from './documentAnalysisService' (if analysis needed)

2. Export `EnhancementState` type for UI status tracking:
```typescript
export type EnhancementState =
  | { status: 'idle' }
  | { status: 'analyzing'; progress: number }
  | { status: 'enhancing'; progress: number }
  | { status: 'complete'; result: EnhancementResult }
  | { status: 'error'; error: string }
  | { status: 'cancelled' };
```

3. Export `enhanceUploadedDocument` async function:
```typescript
export async function enhanceUploadedDocument(
  resource: UploadedResource,
  analysis: DocumentAnalysis,  // Pre-analyzed (from Phase 44)
  slides: Slide[],
  provider: AIProviderInterface,
  options: EnhancementOptions,
  signal?: AbortSignal,
  onProgress?: (state: EnhancementState) => void
): Promise<EnhancementResult> {
  try {
    // Report enhancing state
    onProgress?.({ status: 'enhancing', progress: 0 });

    // Build slide context (limited to 15 slides per research)
    const slideContext = buildSlideContextForEnhancement(slides);

    // Call AI provider
    onProgress?.({ status: 'enhancing', progress: 50 });
    const result = await provider.enhanceDocument(analysis, slideContext, options, signal);

    onProgress?.({ status: 'complete', result });
    return result;
  } catch (error) {
    if ((error as Error).name === 'AbortError') {
      onProgress?.({ status: 'cancelled' });
      throw error;  // Re-throw for caller to handle
    }
    const errorMessage = error instanceof Error ? error.message : 'Enhancement failed';
    onProgress?.({ status: 'error', error: errorMessage });
    throw error;
  }
}
```

4. Export `getDefaultEnhancementOptions(): EnhancementOptions` helper:
```typescript
export function getDefaultEnhancementOptions(): EnhancementOptions {
  return {
    preserveMode: true,  // ENHANCE-01: preserve mode default
    generateAnswerKey: true,  // ENHANCE-04: answer key generation
    gradeLevel: 'Year 6 (10-11 years old)'
  };
}
```

Note: The analysis step is assumed to already be complete (from UploadPanel upload flow). This service focuses on the enhancement step only.
  </action>
  <verify>TypeScript compiles and file exists: `ls services/documentEnhancement/documentEnhancementService.ts && npx tsc --noEmit`</verify>
  <done>Enhancement service created with orchestration pipeline, state tracking, and cancellation support</done>
</task>

</tasks>

<verification>
1. Both providers implement enhanceDocument method
2. Gemini uses responseSchema for structured output
3. Claude uses tool_choice for structured output
4. Both accept AbortSignal for cancellation (ENHANCE-05)
5. Enhancement service exports enhanceUploadedDocument function
6. EnhancementState type covers all UI states (idle, analyzing, enhancing, complete, error, cancelled)
7. TypeScript compiles without errors
</verification>

<success_criteria>
- `npx tsc --noEmit` passes
- GeminiProvider.enhanceDocument returns EnhancementResult with 3 versions + answer keys
- ClaudeProvider.enhanceDocument returns EnhancementResult with 3 versions + answer keys
- Cancellation via AbortSignal properly aborts enhancement request
- Enhancement service provides progress callback for UI updates
- Default options include preserveMode: true and generateAnswerKey: true
</success_criteria>

<output>
After completion, create `.planning/phases/45-enhancement-with-lesson-context/45-02-SUMMARY.md`
</output>
