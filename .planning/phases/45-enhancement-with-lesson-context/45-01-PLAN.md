---
phase: 45-enhancement-with-lesson-context
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types.ts
  - services/documentEnhancement/enhancementPrompts.ts
  - services/aiProvider.ts
autonomous: true

must_haves:
  truths:
    - "Enhancement types support three differentiation levels"
    - "Enhancement types include slide match detection"
    - "Enhancement types include answer key structure"
    - "AI provider interface includes enhanceDocument method signature"
  artifacts:
    - path: "types.ts"
      provides: "EnhancementResult, DifferentiatedVersion, SlideMatch, AnswerKey types"
      contains: "EnhancementResult"
    - path: "services/documentEnhancement/enhancementPrompts.ts"
      provides: "System prompts for enhancement with differentiation rules"
      exports: ["ENHANCEMENT_SYSTEM_PROMPT", "buildEnhancementUserPrompt"]
    - path: "services/aiProvider.ts"
      provides: "enhanceDocument method signature on AIProviderInterface"
      contains: "enhanceDocument"
  key_links:
    - from: "types.ts"
      to: "services/aiProvider.ts"
      via: "EnhancementResult import"
      pattern: "import.*EnhancementResult"
---

<objective>
Define enhancement types, AI prompts, and provider interface extension for document differentiation.

Purpose: Establish the type contracts and prompt engineering foundation that the enhancement service and UI will build upon. This enables all three differentiation levels (simple/standard/detailed) plus answer key generation.

Output: Types for enhancement results, prompts for AI differentiation, and `enhanceDocument` method signature on AIProviderInterface.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-enhancement-with-lesson-context/45-CONTEXT.md
@.planning/phases/45-enhancement-with-lesson-context/45-RESEARCH.md
@.planning/phases/44-ai-document-analysis/44-01-SUMMARY.md
@types.ts
@services/aiProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add enhancement types to types.ts</name>
  <files>types.ts</files>
  <action>
Add enhancement-related types at the end of the DOCUMENT ANALYSIS TYPES section (after DocumentAnalysis interface). Include:

1. `SlideMatch` interface:
   - slideIndex: number (0-indexed)
   - slideTitle: string
   - relevanceScore: 'high' | 'medium' | 'low'
   - reason: string (brief explanation for teacher)

2. `EnhancedElement` interface (mirrors AnalyzedElement with enhancements):
   - type: ElementType
   - originalContent: string (preserved from analysis)
   - enhancedContent: string (may differ based on level)
   - position: number
   - visualContent?: boolean (preserved - signals "don't modify")
   - slideReference?: string (added: "See Slide 5 (Fractions)")
   - children?: string[]
   - tableData?: { headers: string[]; rows: string[][] }

3. `DifferentiatedVersion` interface:
   - level: 'simple' | 'standard' | 'detailed'
   - title: string (may be enhanced from original)
   - alignedSlides: number[] (1-indexed slide numbers this relates to)
   - slideAlignmentNote: string (e.g., "Worksheet 1 aligns with Slides 5-7")
   - elements: EnhancedElement[]

4. `AnswerKeyItem` interface:
   - questionRef: string (e.g., "Question 1" or "Exercise A, part 2")
   - type: 'closed' | 'open-ended'
   - answer?: string (for closed questions)
   - rubric?: { criteria: string[]; exemplar?: string; commonMistakes?: string[] }

5. `AnswerKey` interface:
   - level?: 'simple' | 'standard' | 'detailed' (if per-level)
   - items: AnswerKeyItem[]

6. `AnswerKeyResult` interface:
   - structure: 'unified' | 'per-level'
   - keys: AnswerKey[]

7. `EnhancementResult` interface:
   - slideMatches: SlideMatch[] (which slides this resource aligns with)
   - versions: { simple: DifferentiatedVersion; standard: DifferentiatedVersion; detailed: DifferentiatedVersion }
   - answerKeys: AnswerKeyResult

8. `EnhancementOptions` interface:
   - preserveMode: boolean (true = preserve original, false = allow modification - future)
   - generateAnswerKey: boolean
   - gradeLevel: string (e.g., "Year 6 (10-11 years old)")

Add section comment: `// DOCUMENT ENHANCEMENT TYPES (Phase 45)`
  </action>
  <verify>TypeScript compiles without errors: `cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - Cue" && npx tsc --noEmit`</verify>
  <done>All enhancement types defined, exported, and compile successfully</done>
</task>

<task type="auto">
  <name>Task 2: Create enhancement prompts</name>
  <files>services/documentEnhancement/enhancementPrompts.ts</files>
  <action>
Create new file `services/documentEnhancement/enhancementPrompts.ts` with:

1. `ENHANCEMENT_SYSTEM_PROMPT` constant - comprehensive system prompt including:
   - Role: Expert educational content enhancer for worksheet differentiation
   - PRESERVATION RULES (CRITICAL - NEVER VIOLATE):
     * Keep ALL original questions, exercises, and tasks
     * Keep ALL factual information unchanged
     * Keep visual content markers as "[Original diagram: description]"
     * Mark any illegible text as "[unclear in original]"
   - DIFFERENTIATION RULES for each level:
     * SIMPLE: Shorter sentences (max 15 words), simpler vocabulary (Year 4 reading level), same exercises, visual scaffolding (numbered steps, bullets), remove complex subordinate clauses
     * STANDARD: Clean formatting, clear wording, echo terminology from aligned slides, add "See Slide X" references where helpful, Year 6 reading level
     * DETAILED: Add extension questions or "Going Further" section, include hints/scaffolding/worked examples, add reasoning prompts ("Explain why...", "What would happen if..."), challenge vocabulary (Year 7-8 level), all Standard content PLUS extensions
   - SLIDE ALIGNMENT rules:
     * Identify which slides the resource content relates to
     * Reference slide numbers in header/footer area
     * Echo key terminology and concepts from aligned slides
     * Each version clearly shows which slides it aligns with
   - ANSWER KEY rules:
     * Generate from ENHANCED versions (not original)
     * For closed questions: provide specific answers
     * For open-ended questions: provide rubric with criteria, exemplar, common mistakes
     * Decision on unified vs per-level key depends on how much content diverges

2. `buildEnhancementUserPrompt(documentAnalysis: DocumentAnalysis, slideContext: string, options: EnhancementOptions): string` function:
   - Include document title and type from analysis
   - Format all elements from analysis (numbered, with content)
   - Flag visual content elements as "[Visual element - preserve placeholder]"
   - Include slide context (formatted slide content for alignment)
   - Include grade level from options
   - Request structured JSON output

Import DocumentAnalysis and EnhancementOptions from '../../types'.
  </action>
  <verify>File exists and TypeScript compiles: `ls services/documentEnhancement/enhancementPrompts.ts && npx tsc --noEmit`</verify>
  <done>Enhancement prompts file created with system prompt and user prompt builder</done>
</task>

<task type="auto">
  <name>Task 3: Extend AIProviderInterface with enhanceDocument</name>
  <files>services/aiProvider.ts</files>
  <action>
1. Add import for EnhancementResult and EnhancementOptions from '../types'

2. Add `enhanceDocument` method signature to `AIProviderInterface`:
```typescript
// Document enhancement for resource differentiation (Phase 45)
enhanceDocument(
  documentAnalysis: DocumentAnalysis,
  slideContext: string,       // Formatted slide content for alignment
  options: EnhancementOptions,
  signal?: AbortSignal        // For cancellation support (ENHANCE-05)
): Promise<EnhancementResult>;
```

3. Add helper function `buildSlideContextForEnhancement(slides: Slide[]): string`:
   - Takes array of Slide objects
   - Returns formatted string: each slide as "Slide N: 'Title'\nContent: bullet1; bullet2; bullet3"
   - Limit to first 15 slides to avoid token overflow
   - Add note if truncated: "[Showing first 15 of N slides]"

Note: The actual provider implementations (Gemini, Claude) will be added in Plan 02.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>AIProviderInterface extended with enhanceDocument signature and slide context helper</done>
</task>

</tasks>

<verification>
1. All types defined in types.ts compile without errors
2. Enhancement prompts file exists and exports ENHANCEMENT_SYSTEM_PROMPT and buildEnhancementUserPrompt
3. AIProviderInterface includes enhanceDocument method signature
4. buildSlideContextForEnhancement helper function exists
5. All imports resolve correctly
</verification>

<success_criteria>
- TypeScript compiles with no errors (`npx tsc --noEmit`)
- Enhancement types support: 3 differentiation levels, slide matching, answer keys
- System prompt includes preservation rules, differentiation rules per level, slide alignment
- User prompt builder accepts DocumentAnalysis and formats for AI consumption
- AIProviderInterface.enhanceDocument signature includes AbortSignal for cancellation
</success_criteria>

<output>
After completion, create `.planning/phases/45-enhancement-with-lesson-context/45-01-SUMMARY.md`
</output>
