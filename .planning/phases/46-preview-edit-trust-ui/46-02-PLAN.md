---
phase: 46-preview-edit-trust-ui
plan: 02
type: execute
wave: 2
depends_on: [46-01]
files_modified:
  - components/EnhancementPanel.tsx
  - package.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can toggle 'Show Changes' to see visual diff"
    - "Diff view highlights additions in green and removals in strikethrough"
    - "User can click regenerate icon on any element to regenerate just that element"
    - "Per-element regeneration updates only that element, preserving other edits"
  artifacts:
    - path: "components/EnhancementPanel.tsx"
      provides: "Diff view toggle, per-element regenerate buttons, regenerateElement function"
      contains: "showDiff"
    - path: "package.json"
      provides: "react-diff-viewer dependency"
      contains: "react-diff-viewer"
  key_links:
    - from: "EnhancementPanel.tsx"
      to: "react-diff-viewer"
      via: "ReactDiffViewer component"
      pattern: "ReactDiffViewer"
    - from: "regenerate button"
      to: "provider.enhanceDocument"
      via: "regenerateElement function"
      pattern: "regenerateElement"
---

<objective>
Add visual diff view and per-element regeneration to EnhancementPanel

Purpose: Teachers need to see what the AI changed (builds trust) and regenerate specific elements that need improvement (avoids re-running entire enhancement). Visual diff shows original vs enhanced side-by-side.

Output: EnhancementPanel with "Show Changes" toggle for diff view, and regenerate icon buttons on each element for targeted AI regeneration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-preview-edit-trust-ui/46-CONTEXT.md
@.planning/phases/46-preview-edit-trust-ui/46-RESEARCH.md
@.planning/phases/46-preview-edit-trust-ui/46-01-SUMMARY.md
@components/EnhancementPanel.tsx
@services/documentEnhancement/enhancementPrompts.ts
@services/documentEnhancement/documentEnhancementService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-diff-viewer and add diff view toggle</name>
  <files>package.json, components/EnhancementPanel.tsx</files>
  <action>
1. Install react-diff-viewer:
```bash
cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - Cue" && npm install react-diff-viewer-continued
```

Note: Use `react-diff-viewer-continued` which is the maintained fork of the original `react-diff-viewer` (last updated 2024, supports React 18+).

2. In EnhancementPanel.tsx, add import:
```typescript
import ReactDiffViewer, { DiffMethod } from 'react-diff-viewer-continued';
```

3. Add state for diff view toggle:
```typescript
const [showDiff, setShowDiff] = useState(false);
```

4. Add "Show Changes" toggle button next to the Edit button:
```tsx
<button
  onClick={() => setShowDiff(!showDiff)}
  className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
    showDiff
      ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'
      : 'bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'
  }`}
>
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
  </svg>
  {showDiff ? 'Showing Changes' : 'Show Changes'}
</button>
```

5. When showDiff is true AND isEditMode is false, replace normal element rendering with diff view. Note: Diff and Edit modes are mutually exclusive (turn off edit mode when showing diff).

```typescript
// When entering diff mode, exit edit mode
useEffect(() => {
  if (showDiff && isEditMode) {
    setIsEditMode(false);
  }
}, [showDiff]);
```
  </action>
  <verify>
1. Package installed: `cat package.json | grep react-diff-viewer`
2. TypeScript compiles: `npm run build`
3. Dev server runs without errors
  </verify>
  <done>react-diff-viewer-continued installed, showDiff state added, Show Changes toggle button visible</done>
</task>

<task type="auto">
  <name>Task 2: Implement diff rendering for elements</name>
  <files>components/EnhancementPanel.tsx</files>
  <action>
1. Create a renderElementWithDiff function that shows original vs enhanced content:

```tsx
const renderElementWithDiff = (element: EnhancedElement, index: number) => {
  const baseClasses = 'mb-4';

  // Non-text elements don't need diff view
  if (['diagram', 'image', 'blank-space'].includes(element.type)) {
    return renderElement(element, index);
  }

  // Tables - show simple text comparison for now
  if (element.type === 'table') {
    return renderElement(element, index);
  }

  // Get content to compare
  const originalContent = element.originalContent;
  const enhancedContent = editState.edits[selectedLevel].get(element.position) ?? element.enhancedContent;

  // If no changes, show normal element
  if (originalContent === enhancedContent) {
    return (
      <div key={index} className={`${baseClasses} text-slate-500 dark:text-slate-400 italic`}>
        <span className="text-xs bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded mr-2">Unchanged</span>
        {enhancedContent}
      </div>
    );
  }

  // For lists, join children for comparison
  const originalText = element.type === 'list' && element.children
    ? element.children.join('\n')
    : originalContent;
  const enhancedText = element.type === 'list'
    ? (editState.edits[selectedLevel].get(element.position) ?? element.children?.join('\n') ?? element.enhancedContent)
    : enhancedContent;

  return (
    <div key={index} className={`${baseClasses} rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700`}>
      <div className="text-xs bg-slate-100 dark:bg-slate-800 px-3 py-1 font-medium text-slate-600 dark:text-slate-400 capitalize">
        {element.type}
        {element.slideReference && (
          <span className="ml-2 text-indigo-500 dark:text-indigo-400">({element.slideReference})</span>
        )}
      </div>
      <ReactDiffViewer
        oldValue={originalText}
        newValue={enhancedText}
        splitView={false}
        compareMethod={DiffMethod.WORDS}
        hideLineNumbers={true}
        showDiffOnly={false}
        useDarkTheme={document.documentElement.classList.contains('dark')}
        styles={{
          variables: {
            light: {
              diffViewerBackground: '#ffffff',
              addedBackground: '#dcfce7',
              addedColor: '#166534',
              removedBackground: '#fee2e2',
              removedColor: '#991b1b',
              wordAddedBackground: '#bbf7d0',
              wordRemovedBackground: '#fecaca',
              addedGutterBackground: '#dcfce7',
              removedGutterBackground: '#fee2e2',
              gutterBackground: '#f8fafc',
              gutterBackgroundDark: '#f1f5f9',
              codeFoldBackground: '#f8fafc',
              codeFoldGutterBackground: '#f1f5f9',
            },
            dark: {
              diffViewerBackground: '#1e293b',
              addedBackground: '#14532d40',
              addedColor: '#86efac',
              removedBackground: '#7f1d1d40',
              removedColor: '#fca5a5',
              wordAddedBackground: '#16a34a40',
              wordRemovedBackground: '#dc262640',
              addedGutterBackground: '#14532d40',
              removedGutterBackground: '#7f1d1d40',
              gutterBackground: '#0f172a',
              gutterBackgroundDark: '#1e293b',
              codeFoldBackground: '#0f172a',
              codeFoldGutterBackground: '#1e293b',
            },
          },
          contentText: {
            fontFamily: 'inherit',
            fontSize: '0.875rem',
            lineHeight: '1.5',
          },
        }}
      />
    </div>
  );
};
```

2. Modify the element rendering in the results section to use diff view when showDiff is true:

```tsx
{/* Elements */}
<div className="space-y-2">
  {selectedVersion.elements.map((element, index) =>
    showDiff
      ? renderElementWithDiff(element, index)
      : renderElement(element, index)
  )}
</div>
```

3. Add note at top of diff view explaining the colors:
```tsx
{showDiff && (
  <div className="mb-4 p-3 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm text-slate-600 dark:text-slate-400">
    <span className="font-medium">Reading the diff:</span>{' '}
    <span className="bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 px-1 rounded">Red/strikethrough</span> = original text removed,{' '}
    <span className="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-1 rounded">Green</span> = new text added
  </div>
)}
```
  </action>
  <verify>
1. Click "Show Changes" toggle
2. Verify diff view appears showing original vs enhanced
3. Green highlighting for additions, red for removals
4. Unchanged elements marked as "Unchanged"
5. Dark mode styling works correctly
  </verify>
  <done>Diff view renders showing original vs enhanced content with word-level highlighting, dark mode support</done>
</task>

<task type="auto">
  <name>Task 3: Add per-element regenerate functionality</name>
  <files>components/EnhancementPanel.tsx</files>
  <action>
1. Add state for tracking which element is being regenerated:
```typescript
const [regeneratingPosition, setRegeneratingPosition] = useState<number | null>(null);
```

2. Create regenerateElement function that calls the AI provider for a single element:

```typescript
const regenerateElement = async (element: EnhancedElement) => {
  if (regeneratingPosition !== null) return; // Already regenerating

  setRegeneratingPosition(element.position);

  try {
    // Build a focused prompt for single element regeneration
    const elementPrompt = `Regenerate ONLY this single ${element.type} element for the ${selectedLevel.toUpperCase()} differentiation level.

ORIGINAL CONTENT:
${element.originalContent}

CURRENT ENHANCED CONTENT:
${element.enhancedContent}

CONTEXT: This is from a ${analysis.documentType} at grade level ${slides.length > 0 ? 'aligned to lesson slides' : 'standalone'}.

DIFFERENTIATION LEVEL: ${selectedLevel}
${selectedLevel === 'simple' ? '- Shorter sentences (max 15 words)\n- Year 4 vocabulary (ages 8-9)\n- Clear, concrete language' : ''}
${selectedLevel === 'standard' ? '- Clear formatting\n- Year 6 vocabulary (ages 10-11)\n- Echo slide terminology' : ''}
${selectedLevel === 'detailed' ? '- Add depth and reasoning prompts\n- Year 7-8 vocabulary (ages 11-13)\n- Include scaffolding hints' : ''}

RULES:
- Preserve all factual information
- Keep the same element type (${element.type})
- Return ONLY the regenerated content text, nothing else
- Do NOT include element type labels or formatting markers

Regenerate the content now:`;

    // Use the provider directly for a quick single-element call
    const response = await provider.generateSlides(
      elementPrompt,
      undefined, // No abort signal for quick calls
      undefined  // No progress callback
    );

    // Extract the regenerated content from response
    // The response will be raw text since we asked for just the content
    const regeneratedContent = response.slides?.[0]?.content?.[0] ||
                              response.slides?.[0]?.speakerNotes ||
                              element.enhancedContent;

    // Clean up the response (remove any accidental markers)
    const cleanContent = regeneratedContent
      .replace(/^(HEADER|PARAGRAPH|QUESTION|INSTRUCTION|SUBHEADER|ANSWER|LIST):?\s*/i, '')
      .trim();

    // Update the result with regenerated content
    if (result) {
      const updatedResult = { ...result };
      const levelVersion = updatedResult.versions[selectedLevel];
      const elementIndex = levelVersion.elements.findIndex(e => e.position === element.position);

      if (elementIndex !== -1) {
        levelVersion.elements[elementIndex] = {
          ...levelVersion.elements[elementIndex],
          enhancedContent: cleanContent
        };
        setResult(updatedResult);
      }
    }

    // Clear any edit for this element since we have fresh AI content
    dispatch({ type: 'REVERT_ELEMENT', level: selectedLevel, position: element.position });

  } catch (error) {
    onError('Regeneration Failed', `Could not regenerate element: ${(error as Error).message}`);
  } finally {
    setRegeneratingPosition(null);
  }
};
```

3. Add regenerate button to each element in edit mode. Modify renderElement to include a regenerate icon:

```tsx
// Add this to each text element type's render, after the content
{isEditMode && !['diagram', 'image', 'blank-space', 'table'].includes(element.type) && (
  <div className="flex items-center gap-2 mt-1">
    {isEdited && (
      <button
        onClick={() => dispatch({ type: 'REVERT_ELEMENT', level: selectedLevel, position: element.position })}
        className="text-xs text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
        title="Revert to AI version"
      >
        <svg className="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
        </svg>
        <span className="ml-1">Revert</span>
      </button>
    )}
    <button
      onClick={() => regenerateElement(element)}
      disabled={regeneratingPosition !== null}
      className={`text-xs flex items-center gap-1 ${
        regeneratingPosition === element.position
          ? 'text-indigo-500 dark:text-indigo-400'
          : 'text-slate-400 hover:text-indigo-500 dark:hover:text-indigo-400'
      }`}
      title="Regenerate this element with AI"
    >
      {regeneratingPosition === element.position ? (
        <svg className="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      ) : (
        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      )}
      <span>{regeneratingPosition === element.position ? 'Regenerating...' : 'Regenerate'}</span>
    </button>
  </div>
)}
```

4. Disable the full "Regenerate Enhancement" button while per-element regeneration is in progress:

```tsx
<Button
  variant="secondary"
  onClick={handleEnhance}
  className="w-full"
  disabled={regeneratingPosition !== null}
>
  {regeneratingPosition !== null ? 'Regenerating element...' : 'Regenerate Enhancement'}
</Button>
```
  </action>
  <verify>
1. Enable edit mode
2. Click regenerate icon on an element
3. Verify loading spinner appears on that element
4. Verify element content updates after regeneration
5. Verify other elements remain unchanged
6. Verify edit state for that element is cleared after regeneration
  </verify>
  <done>Per-element regenerate buttons visible in edit mode, clicking regenerates single element via AI, other content preserved</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run build`
2. "Show Changes" toggle appears and works
3. Diff view shows word-level highlighting (green=added, red=removed)
4. Diff view respects dark mode
5. "Unchanged" label shows for elements with no differences
6. Regenerate icons visible in edit mode
7. Clicking regenerate updates single element
8. Cannot regenerate while another regeneration is in progress
9. Edit mode and diff mode are mutually exclusive
</verification>

<success_criteria>
- User can toggle "Show Changes" to see visual diff of original vs enhanced
- Diff uses word-level comparison with clear color coding
- User can click regenerate icon on any text element
- Per-element regeneration shows loading state
- Regeneration updates only that element, preserving other edits
- Full "Regenerate Enhancement" button disabled during per-element regen
- Dark mode styling works correctly for diff view
</success_criteria>

<output>
After completion, create `.planning/phases/46-preview-edit-trust-ui/46-02-SUMMARY.md`
</output>
