---
phase: 02-snap-to-grid-persistence
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - components/FloatingWindow.tsx
  - components/GridOverlay.tsx
autonomous: false

must_haves:
  truths:
    - "Toggle button on preview window enables/disables snap-to-grid"
    - "When snap enabled, dragging preview snaps to 50px grid positions"
    - "When snap enabled, resizing preview snaps to 50px grid increments"
    - "Grid lines appear while dragging with snap enabled"
    - "Button visual indicates current snap state (blue=on, gray=off)"
  artifacts:
    - path: "components/FloatingWindow.tsx"
      provides: "Snap toggle button, dragGrid/resizeGrid props applied"
      min_lines: 250
    - path: "components/GridOverlay.tsx"
      provides: "SVG grid overlay shown during drag when snap enabled"
      min_lines: 30
  key_links:
    - from: "components/FloatingWindow.tsx"
      to: "react-rnd"
      via: "dragGrid and resizeGrid props"
      pattern: "dragGrid=|resizeGrid="
    - from: "components/FloatingWindow.tsx"
      to: "components/GridOverlay.tsx"
      via: "conditional render based on isDragging && snapEnabled"
      pattern: "<GridOverlay"
---

<objective>
Implement snap-to-grid UI and behavior for preview window.

Purpose: Allow teachers to align preview window to a neat grid for precise positioning, with visual feedback showing the grid while dragging.

Output:
- Snap toggle button in preview window (top-right corner)
- Grid lines overlay during drag
- react-rnd grid snapping via dragGrid/resizeGrid props
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-snap-to-grid-persistence/02-CONTEXT.md
@.planning/phases/02-snap-to-grid-persistence/02-RESEARCH.md
@.planning/phases/02-snap-to-grid-persistence/02-01-SUMMARY.md
@components/FloatingWindow.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GridOverlay component</name>
  <files>components/GridOverlay.tsx</files>
  <action>
Create a grid overlay component that displays during drag.

Props:
```typescript
interface GridOverlayProps {
  gridSize: number;  // Grid cell size in pixels
  visible: boolean;  // Whether to show the overlay
}
```

Implementation:
1. Return null if not visible
2. Render full-viewport SVG with `pointer-events: none` and `position: fixed`
3. Use SVG pattern element for efficient grid rendering:
   ```tsx
   <svg
     className="pointer-events-none fixed inset-0 w-full h-full"
     style={{ zIndex: 9998 }}  // Below FloatingWindow (9999)
     xmlns="http://www.w3.org/2000/svg"
   >
     <defs>
       <pattern
         id="grid-pattern"
         width={gridSize}
         height={gridSize}
         patternUnits="userSpaceOnUse"
       >
         <path
           d={`M ${gridSize} 0 L 0 0 0 ${gridSize}`}
           fill="none"
           stroke="rgba(99, 102, 241, 0.15)"  // Subtle indigo
           strokeWidth="1"
         />
       </pattern>
     </defs>
     <rect width="100%" height="100%" fill="url(#grid-pattern)" />
   </svg>
   ```
4. Keep opacity subtle (0.15-0.2) so it doesn't distract from content

Pattern reference: See RESEARCH.md "Pattern 4: Visual Grid Overlay"
  </action>
  <verify>
- File exists at components/GridOverlay.tsx
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
GridOverlay component created with SVG pattern for efficient grid rendering, styled with subtle indigo color and pointer-events: none.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add snap toggle button and grid behavior to FloatingWindow</name>
  <files>components/FloatingWindow.tsx</files>
  <action>
Add snap toggle button and implement grid snapping behavior.

Constants:
```typescript
const GRID_SIZE = 50;  // 50px grid per CONTEXT.md decision
```

Changes to make:

1. Import GridOverlay:
   ```typescript
   import GridOverlay from './GridOverlay';
   ```

2. Add internal dragging state for grid overlay (if not already controlled):
   ```typescript
   const [isCurrentlyDragging, setIsCurrentlyDragging] = useState(false);
   // Use prop if controlled, internal state if not
   const dragging = isDragging !== undefined ? isDragging : isCurrentlyDragging;
   ```

3. Add Snap Toggle Button inside the Rnd children (after the content div):
   ```tsx
   {/* Snap toggle button - always visible, top-right corner */}
   {onSnapToggle && (
     <button
       onClick={(e) => {
         e.stopPropagation();  // Prevent drag start
         onSnapToggle();
       }}
       className={`
         absolute top-2 right-2 z-10
         w-6 h-6 rounded
         flex items-center justify-center
         transition-colors duration-150
         ${snapEnabled
           ? 'bg-indigo-500 text-white shadow-md'
           : 'bg-slate-200 text-slate-500 hover:bg-slate-300'
         }
       `}
       title={snapEnabled ? 'Snap to grid: ON' : 'Snap to grid: OFF'}
     >
       {/* Grid icon - 4 squares */}
       <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
           d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"
         />
       </svg>
     </button>
   )}
   ```

4. Apply dragGrid and resizeGrid props to Rnd:
   ```tsx
   <Rnd
     dragGrid={snapEnabled ? [GRID_SIZE, GRID_SIZE] : [1, 1]}
     resizeGrid={snapEnabled ? [GRID_SIZE, GRID_SIZE] : [1, 1]}
     // ... other props
   >
   ```

5. Update onDragStart handler to set internal dragging state:
   ```typescript
   onDragStart={() => {
     setIsDragging(true);
     setIsCurrentlyDragging(true);
     onDragStart?.();
   }}
   ```

6. Update onDragStop handler to clear dragging state:
   ```typescript
   onDragStop={...} // existing logic plus:
   setIsCurrentlyDragging(false);
   onDragEnd?.();
   ```

7. Render GridOverlay via React fragment (before Rnd):
   ```tsx
   return (
     <>
       <GridOverlay gridSize={GRID_SIZE} visible={dragging && !!snapEnabled} />
       <Rnd ...>
         ...
       </Rnd>
     </>
   );
   ```

8. Position and size: use props if provided, otherwise internal state (from Task 2 of Plan 01)

IMPORTANT: The toggle button must have `onClick` with `e.stopPropagation()` to prevent triggering drag.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Dev server runs without errors: `npm run dev`
- In presentation mode, toggle button appears on preview window
  </verify>
  <done>
FloatingWindow has snap toggle button (top-right, blue when enabled), applies dragGrid/resizeGrid when snap enabled, and shows GridOverlay during drag.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete snap-to-grid feature:
- Toggle button on preview window (top-right corner)
- Grid lines appear during drag when snap is enabled
- Window snaps to 50px grid positions during drag
- Window resize snaps to 50px increments
- Snap state persists across sessions (from Plan 01)
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Click "Present" to enter presentation mode
3. Click "Preview" to show the floating preview window
4. Verify toggle button appears in top-right corner of preview (gray grid icon)
5. Drag the preview window - should move freely (no snapping)
6. Click the toggle button - should turn blue
7. Drag the preview window again - should:
   a. Show grid lines over the entire viewport
   b. Snap to grid positions (every 50px)
8. Resize the preview from corners - should snap to grid increments
9. Click toggle button again to disable - should turn gray
10. Drag again - should move freely, no grid lines
11. Enable snap, position window, refresh page
12. Return to presentation mode - verify snap is still enabled and position preserved

Expected behavior:
- Toggle clearly indicates state (blue=on, gray=off)
- Grid lines are subtle but visible (indigo color, low opacity)
- Snapping feels "magnetic" as window jumps to grid positions
- No interference with drag operation (button click doesn't trigger drag)
  </how-to-verify>
  <resume-signal>Type "approved" if snap-to-grid works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Toggle button visible on preview window
2. Toggle changes color: blue when enabled, gray when disabled
3. Grid lines appear during drag when snap enabled
4. Grid lines do NOT appear when snap disabled
5. Preview snaps to 50px grid positions when snap enabled
6. Preview moves freely when snap disabled
7. Resize snaps to 50px increments when snap enabled
8. Snap state persists after page refresh
9. Button click does not trigger drag
</verification>

<success_criteria>
- PREV-06: Toggle button exists on preview window
- PREV-07: Window snaps to grid positions during drag when enabled
- PREV-08: Button visual indicates snap state (blue/gray)
- Grid overlay appears during drag when snap enabled
- All Phase 2 requirements (PREV-06 through PREV-11) complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-snap-to-grid-persistence/02-02-SUMMARY.md`
</output>
