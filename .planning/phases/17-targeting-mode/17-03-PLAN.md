---
phase: 17-targeting-mode
plan: 03
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - components/PresentationView.tsx
autonomous: true

must_haves:
  truths:
    - "Progress counter shows X of Y students asked"
    - "Counter is tappable to expand student list with checkmarks"
    - "Teacher can manually mark students as asked"
    - "Selected student name visible in question display"
    - "Dismissing question returns to neutral state"
  artifacts:
    - path: "components/PresentationView.tsx"
      provides: "Progress counter UI, expandable list, manual marking, student name in question"
      contains: "isCounterExpanded, markStudentAsked, currentlySelectedStudent"
  key_links:
    - from: "Question button click"
      to: "quickQuestion state"
      via: "Sets student name along with question"
      pattern: "setQuickQuestion.*studentName"
    - from: "Counter click"
      to: "Expanded list"
      via: "isCounterExpanded toggle"
      pattern: "setIsCounterExpanded.*!.*isCounterExpanded"
---

<objective>
Add progress counter, expandable list, and polish question display integration

Purpose: Teachers need visibility into cycling progress ("5 of 24 students asked") and ability to manually mark students who answered voluntarily. The question display should show which student was selected.

Output: Tappable progress counter, expandable student list with checkmarks, manual marking capability, and enhanced question display with student name.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

@.planning/phases/17-targeting-mode/17-CONTEXT.md
@.planning/phases/17-targeting-mode/17-RESEARCH.md
@.planning/phases/17-targeting-mode/17-01-SUMMARY.md
@.planning/phases/17-targeting-mode/17-02-SUMMARY.md

@components/PresentationView.tsx (after Plan 02 - has toggle and conditional UI)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Track selected student and enhance question display</name>
  <files>components/PresentationView.tsx</files>
  <action>
1. Update quickQuestion state to include student name (around line 250):

Change from:
```typescript
const [quickQuestion, setQuickQuestion] = useState<{
  question: string;
  answer: string;
  level: string;
} | null>(null);
```

To:
```typescript
const [quickQuestion, setQuickQuestion] = useState<{
  question: string;
  answer: string;
  level: string;
  studentName?: string;  // For Targeted mode
} | null>(null);
```

2. Update the Question button onClick in Targeted mode section (from Plan 02) to include student name:

Find the Question button onClick handler and update to:
```typescript
onClick={() => {
  if (nextStudent) {
    handleGenerateQuestion(nextStudent.grade);
    // Store selected student for display
    setQuickQuestion(prev => prev ? { ...prev, studentName: nextStudent.name } : null);
  }
  setCyclingState(prev => advanceCycling(prev, studentData));
}}
```

Actually, we need a different approach since handleGenerateQuestion sets quickQuestion. Instead, modify handleGenerateQuestion to accept optional studentName:

3. Update handleGenerateQuestion function (around line 350):

Change from:
```typescript
const handleGenerateQuestion = async (level: 'A' | 'B' | 'C' | 'D' | 'E') => {
```

To:
```typescript
const handleGenerateQuestion = async (level: 'A' | 'B' | 'C' | 'D' | 'E', studentName?: string) => {
```

And update the setQuickQuestion call inside:
```typescript
setQuickQuestion({
  question: result.question,
  answer: result.answer,
  level: `Grade ${level}`,
  studentName,  // Add this
});
```

4. Update the Question button in Targeted mode to pass studentName:
```typescript
onClick={() => {
  if (nextStudent) {
    handleGenerateQuestion(nextStudent.grade, nextStudent.name);
  }
  setCyclingState(prev => advanceCycling(prev, studentData));
}}
```

5. Update the question display section (around line 813) to show student name:

After the level badge (around line 825), add student name if present:
```tsx
{quickQuestion.studentName && (
  <span className="ml-2 text-[10px] font-bold text-indigo-400">
    for {quickQuestion.studentName}
  </span>
)}
```
  </action>
  <verify>`npm run build` succeeds. Question display shows student name in Targeted mode.</verify>
  <done>Question display includes student name when generated in Targeted mode</done>
</task>

<task type="auto">
  <name>Task 2: Add progress counter and expandable student list</name>
  <files>components/PresentationView.tsx</files>
  <action>
1. Add counter expansion state (near other Targeting Mode state):
```typescript
const [isCounterExpanded, setIsCounterExpanded] = useState(false);
```

2. Add helper to manually mark student as asked:
```typescript
const markStudentAsAsked = useCallback((studentName: string) => {
  setCyclingState(prev => ({
    ...prev,
    askedStudents: new Set([...prev.askedStudents, studentName]),
  }));
}, []);
```

3. Add progress counter UI in the Targeted mode section, BELOW the Question button div but INSIDE the outer targeted mode container (before the closing of the conditional):

After the Question button, before the closing `</div>` of the Targeted mode section, add:
```tsx
{/* Progress Counter */}
<div className="mt-3 border-t border-slate-600 pt-3">
    <button
        onClick={() => setIsCounterExpanded(!isCounterExpanded)}
        className="w-full text-left text-xs text-slate-400 hover:text-slate-300 flex items-center justify-between transition-colors"
    >
        <span>
            {cyclingState.currentIndex} of {cyclingState.shuffledOrder.length} students asked
        </span>
        <svg
            className={`w-4 h-4 transition-transform ${isCounterExpanded ? 'rotate-180' : ''}`}
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
        >
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
    </button>

    {/* Expanded Student List */}
    {isCounterExpanded && (
        <div className="mt-2 p-2 bg-slate-800 rounded-lg max-h-40 overflow-y-auto space-y-1">
            {cyclingState.shuffledOrder.map((name, idx) => {
                const isAsked = idx < cyclingState.currentIndex || cyclingState.askedStudents.has(name);
                const student = studentData.find(s => s.name === name);
                return (
                    <div
                        key={name}
                        className="flex items-center justify-between text-xs py-1 px-2 rounded hover:bg-slate-700/50"
                    >
                        <div className="flex items-center gap-2">
                            <span className={isAsked ? 'text-green-400' : 'text-slate-500'}>
                                {isAsked ? '✓' : '○'}
                            </span>
                            <span className={isAsked ? 'text-slate-400' : 'text-white'}>
                                {name}
                            </span>
                            {student?.grade && (
                                <span className="text-[9px] text-slate-500">
                                    ({student.grade})
                                </span>
                            )}
                        </div>
                        {!isAsked && (
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    markStudentAsAsked(name);
                                }}
                                className="text-[9px] text-slate-500 hover:text-amber-400 px-1.5 py-0.5 rounded hover:bg-slate-600"
                                title="Mark as asked (answered voluntarily)"
                            >
                                mark
                            </button>
                        )}
                    </div>
                );
            })}
        </div>
    )}
</div>
```

4. Close counter expansion when slide changes - add to the existing useEffect that resets cycling:
```typescript
useEffect(() => {
  setCyclingState(initializeCycling(studentData));
  setIsCounterExpanded(false);  // Add this line
}, [currentIndex, studentData]);
```
  </action>
  <verify>
1. `npm run build` succeeds
2. Progress counter shows "X of Y students asked"
3. Clicking counter expands to show student list
4. Checkmarks show for asked students
5. "mark" button allows manual marking
6. Counter collapses on slide change
  </verify>
  <done>Progress counter visible, tappable to expand, shows checkmarks, allows manual marking</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run build` succeeds
2. Targeted mode shows progress counter below Question button
3. Counter displays "X of Y students asked"
4. Clicking counter shows expandable list with checkmarks
5. Students who've been asked show green checkmark
6. Unasked students have "mark" button for voluntary answers
7. Question display shows "for [StudentName]" in Targeted mode
8. Counter resets when slide changes
</verification>

<success_criteria>
- Progress counter is unobtrusive but visible
- Expanded list scrollable when many students
- Manual marking updates askedStudents Set
- Student name in question display only appears for Targeted mode
- All state resets appropriately on slide change
</success_criteria>

<output>
After completion, create `.planning/phases/17-targeting-mode/17-03-SUMMARY.md`
</output>
