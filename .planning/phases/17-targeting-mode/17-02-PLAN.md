---
phase: 17-targeting-mode
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - components/PresentationView.tsx
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher can toggle between Manual and Targeted modes"
    - "Manual mode shows 5 difficulty buttons (A-E)"
    - "Targeted mode shows single Question button with student preview"
    - "Student preview shows name and grade before clicking"
    - "Skip button allows skipping absent students"
    - "Targeted mode disabled when no class loaded or no grades assigned"
  artifacts:
    - path: "components/PresentationView.tsx"
      provides: "Mode toggle UI, conditional button rendering, student preview display"
      contains: "isTargetedMode, peer-checked, Question button"
    - path: "App.tsx"
      provides: "studentData prop passed to PresentationView"
      contains: "studentData={activeClass?.studentData"
  key_links:
    - from: "PresentationView"
      to: "App.tsx"
      via: "studentData prop"
      pattern: "studentData.*StudentWithGrade"
    - from: "isTargetedMode state"
      to: "conditional rendering"
      via: "ternary in JSX"
      pattern: "isTargetedMode.*\\?.*:.*"
---

<objective>
Add mode toggle UI and conditional button rendering to teleprompter

Purpose: Teachers need to switch between Manual mode (pick difficulty) and Targeted mode (system picks student). The toggle and conditional UI enables this choice.

Output: Working toggle switch, conditional button rendering (5 buttons vs 1), student preview with Skip, and studentData prop wiring from App.tsx.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

@.planning/phases/17-targeting-mode/17-CONTEXT.md
@.planning/phases/17-targeting-mode/17-RESEARCH.md
@.planning/phases/17-targeting-mode/17-01-SUMMARY.md

@types.ts (StudentWithGrade, GradeLevel)
@components/PresentationView.tsx (after Plan 01 - has cycling infrastructure)
@App.tsx (activeClassName, classes state)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pass studentData prop from App.tsx to PresentationView</name>
  <files>App.tsx, components/PresentationView.tsx</files>
  <action>
1. In App.tsx around line 700 where PresentationView is rendered:
   - Before the return, compute: `const activeClass = activeClassName ? classes.find(c => c.name === activeClassName) : null;`
   - Add prop: `studentData={activeClass?.studentData || []}`

2. In PresentationView.tsx, update props interface:
```typescript
interface PresentationViewProps {
  slides: Slide[];
  onExit: () => void;
  studentNames: string[];
  studentData: StudentWithGrade[];  // ADD THIS
  initialSlideIndex?: number;
  provider: AIProviderInterface | null;
  onError: (title: string, message: string) => void;
  onRequestAI: (featureName: string) => void;
}
```

3. Destructure studentData in component function signature:
```typescript
const PresentationView: React.FC<PresentationViewProps> = ({
  slides, onExit, studentNames, studentData, initialSlideIndex = 0, provider, onError, onRequestAI
}) => {
```

Import StudentWithGrade from '../types' at top of PresentationView.tsx if not already done in Plan 01.
  </action>
  <verify>`npm run build` succeeds. PresentationView receives studentData array.</verify>
  <done>studentData prop flows from App.tsx to PresentationView with correct typing</done>
</task>

<task type="auto">
  <name>Task 2: Add mode toggle state and cycling state initialization</name>
  <files>components/PresentationView.tsx</files>
  <action>
In PresentationView component, add state near existing state declarations (around line 240-250):

```typescript
// Targeting Mode State
const [isTargetedMode, setIsTargetedMode] = useState(true); // Default to Targeted per CONTEXT.md
const [cyclingState, setCyclingState] = useState<TargetedCyclingState>(() =>
  initializeCycling(studentData)
);
```

Add helper checks for mode availability:
```typescript
// Derived state for mode availability
const hasStudentsWithGrades = studentData.some(s => s.grade !== null);
const canUseTargetedMode = studentData.length > 0 && hasStudentsWithGrades;
```

Add effect to reset cycling when slide changes (CYCL-04):
```typescript
// Reset cycling state when slide changes
useEffect(() => {
  setCyclingState(initializeCycling(studentData));
}, [currentIndex, studentData]);
```

Get next student for preview:
```typescript
// Next student for Targeted mode preview
const nextStudent = useMemo(() => {
  if (!isTargetedMode || !canUseTargetedMode) return null;
  return getNextStudent(cyclingState, studentData);
}, [isTargetedMode, canUseTargetedMode, cyclingState, studentData]);
```

Import useMemo if not already imported.
  </action>
  <verify>Component renders without errors. `npm run build` succeeds.</verify>
  <done>isTargetedMode state, cyclingState, derived helpers, and slide change reset effect exist</done>
</task>

<task type="auto">
  <name>Task 3: Add mode toggle UI and conditional button rendering</name>
  <files>components/PresentationView.tsx</files>
  <action>
1. Add toggle switch in presenter console header (around line 675, in the div with "Presenter Console" label):

Replace the existing header div content with:
```tsx
<div className="p-3 bg-slate-800/50 border-b border-slate-700 flex justify-between items-center shrink-0">
    <div className="flex items-center gap-3">
        <span className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Presenter Console</span>

        {/* Mode Toggle */}
        <div className="flex items-center gap-2">
            <span className={`text-[10px] font-bold uppercase tracking-wider ${!isTargetedMode ? 'text-slate-300' : 'text-slate-500'}`}>Manual</span>
            <label className="relative inline-flex items-center cursor-pointer">
                <input
                    type="checkbox"
                    className="sr-only peer"
                    checked={isTargetedMode}
                    onChange={() => setIsTargetedMode(!isTargetedMode)}
                    disabled={!canUseTargetedMode}
                />
                <div className={`w-9 h-5 rounded-full peer transition-colors ${
                    canUseTargetedMode
                        ? 'bg-slate-600 peer-checked:bg-amber-500 peer-focus:ring-2 peer-focus:ring-amber-500/50'
                        : 'bg-slate-700 cursor-not-allowed'
                } after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4`}></div>
            </label>
            <span className={`text-[10px] font-bold uppercase tracking-wider ${isTargetedMode && canUseTargetedMode ? 'text-amber-400' : 'text-slate-500'}`}>
                Targeted
            </span>
            {!canUseTargetedMode && (
                <span className="text-[9px] text-slate-500 italic" title="Load a class with grade assignments to use Targeted mode">
                    (assign grades first)
                </span>
            )}
        </div>

        <button onClick={() => setShowFullScript(!showFullScript)} className="text-[10px] text-slate-500 hover:text-slate-300 transition-colors uppercase font-bold tracking-tighter">
            {showFullScript ? 'Close Full Script' : 'Full Script'}
        </button>
    </div>
    <div className="flex gap-1.5">
       {/* existing bullet progress dots */}
       <div className={`w-2 h-2 rounded-full border border-slate-600 ${visibleBullets === 0 ? 'bg-amber-400 shadow-[0_0_5px_rgba(251,191,36,0.5)]' : 'bg-slate-700'}`} />
       {currentSlide.content.map((_, i) => (
           <div key={i} className={`w-2 h-2 rounded-full border border-slate-600 transition-colors ${i + 1 <= visibleBullets ? 'bg-green-400 shadow-[0_0_5px_rgba(74,222,128,0.5)]' : 'bg-slate-700'}`} />
       ))}
    </div>
</div>
```

2. Replace the question buttons section (around line 716) with conditional rendering:

Replace the entire `{/* Differentiated Question Buttons */}` section with:
```tsx
{/* Question Buttons - Mode Dependent */}
{isTargetedMode && canUseTargetedMode ? (
    /* Targeted Mode: Single Question Button with Student Preview */
    <div className={`mt-3 p-3 rounded-xl transition-all ${currentSlide.hasQuestionFlag ? 'bg-amber-500/10 ring-1 ring-amber-500/30' : 'bg-slate-700/50'}`}>
        {currentSlide.hasQuestionFlag && (
            <div className="text-[10px] font-bold text-amber-500 uppercase tracking-widest text-center mb-2">
                Question Time
            </div>
        )}

        {nextStudent ? (
            <div className="space-y-2">
                {/* Student Preview */}
                <div className="flex items-center justify-between">
                    <div className="text-sm text-slate-300">
                        <span className="text-slate-500">Next: </span>
                        <span className="font-bold text-white">{nextStudent.name}</span>
                        <span className={`ml-2 text-[10px] font-bold px-1.5 py-0.5 rounded ${
                            nextStudent.grade === 'A' ? 'bg-rose-900 text-rose-300' :
                            nextStudent.grade === 'B' ? 'bg-orange-900 text-orange-300' :
                            nextStudent.grade === 'C' ? 'bg-amber-900 text-amber-300' :
                            nextStudent.grade === 'D' ? 'bg-green-900 text-green-300' :
                            'bg-emerald-900 text-emerald-300'
                        }`}>
                            Grade {nextStudent.grade}
                        </span>
                    </div>
                    <button
                        onClick={() => setCyclingState(prev => advanceCycling(prev, studentData))}
                        className="text-[10px] text-slate-400 hover:text-white px-2 py-1 rounded bg-slate-600/50 hover:bg-slate-600 transition-colors"
                        title="Skip this student (counts as asked)"
                    >
                        Skip
                    </button>
                </div>

                {/* Question Button */}
                <div className="relative">
                    <button
                        onClick={() => {
                            // Will be wired in Plan 03
                            handleGenerateQuestion(nextStudent.grade);
                            setCyclingState(prev => advanceCycling(prev, studentData));
                        }}
                        className={`w-full bg-amber-600 hover:bg-amber-500 text-white border border-amber-500/50 rounded-lg py-3 text-sm font-bold uppercase tracking-wider transition-colors ${!isAIAvailable ? 'opacity-50' : ''}`}
                        title={!isAIAvailable ? 'Add API key in Settings to enable' : `Generate question for ${nextStudent.name}`}
                    >
                        Question for {nextStudent.name}
                    </button>
                    {!isAIAvailable && (
                        <span className="absolute -top-0.5 -right-0.5 w-4 h-4 bg-slate-500 rounded-full flex items-center justify-center">
                            <svg className="w-2.5 h-2.5 text-white" viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" />
                            </svg>
                        </span>
                    )}
                </div>
            </div>
        ) : (
            <div className="text-center text-slate-500 text-sm py-2">
                No students with grades assigned
            </div>
        )}
    </div>
) : (
    /* Manual Mode: 5 Difficulty Buttons (existing behavior) */
    <div className={`grid grid-cols-5 gap-2 mt-3 p-2 rounded-xl transition-all ${currentSlide.hasQuestionFlag ? 'bg-amber-500/10 ring-1 ring-amber-500/30' : ''}`}>
        {currentSlide.hasQuestionFlag && (
            <div className="col-span-5 text-[10px] font-bold text-amber-500 uppercase tracking-widest text-center mb-1">
                Question Time
            </div>
        )}
        {/* Keep existing 5 button grid - A through E */}
        {(['A', 'B', 'C', 'D', 'E'] as const).map(grade => {
            const colors = {
                A: 'bg-rose-800/50 hover:bg-rose-700 text-rose-200 border-rose-700/50',
                B: 'bg-orange-800/50 hover:bg-orange-700 text-orange-200 border-orange-700/50',
                C: 'bg-amber-800/50 hover:bg-amber-700 text-amber-200 border-amber-700/50',
                D: 'bg-green-800/50 hover:bg-green-700 text-green-200 border-green-700/50',
                E: 'bg-emerald-800/50 hover:bg-emerald-700 text-emerald-200 border-emerald-700/50',
            };
            return (
                <div key={grade} className="relative">
                    <button
                        onClick={() => handleGenerateQuestion(grade)}
                        className={`w-full ${colors[grade]} border rounded-lg py-2 text-[10px] font-bold uppercase tracking-wider transition-colors ${!isAIAvailable ? 'opacity-50' : ''}`}
                        title={!isAIAvailable ? 'Add API key in Settings to enable' : undefined}
                    >
                        {grade}
                    </button>
                    {!isAIAvailable && (
                        <span className="absolute -top-0.5 -right-0.5 w-3 h-3 bg-slate-500 rounded-full flex items-center justify-center">
                            <svg className="w-2 h-2 text-white" viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" />
                            </svg>
                        </span>
                    )}
                </div>
            );
        })}
    </div>
)}
```

This replaces the existing 5 button grid (around lines 717-802) with the conditional rendering.
  </action>
  <verify>
1. `npm run build` succeeds
2. Toggle switch appears in presenter console header
3. Manual mode shows 5 difficulty buttons (A-E)
4. Targeted mode shows student preview and single Question button
5. Toggle disabled when no class loaded or no grades assigned
  </verify>
  <done>Mode toggle visible and functional, conditional UI renders correct buttons based on mode</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run build` succeeds
2. Toggle switch appears between "Manual" and "Targeted" labels
3. Default mode is Targeted (per CONTEXT.md)
4. Targeted mode shows "Next: [Name] (Grade X)" preview with Skip button
5. Targeted mode shows single "Question for [Name]" button
6. Manual mode shows 5 difficulty buttons (A/B/C/D/E)
7. Toggle disabled with "(assign grades first)" when no grades
8. Slide navigation resets cycling state
</verification>

<success_criteria>
- Toggle switch matches codebase toggle pattern (peer checkbox)
- Targeted mode is default
- Student preview shows name and grade
- Skip button advances cycling without generating question
- Manual mode preserves existing 5-button behavior exactly
- Disabled state shows helpful message
</success_criteria>

<output>
After completion, create `.planning/phases/17-targeting-mode/17-02-SUMMARY.md`
</output>
