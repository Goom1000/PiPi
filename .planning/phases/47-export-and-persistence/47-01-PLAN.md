---
phase: 47-export-and-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/exportService.ts
  - components/EnhancementPanel.tsx
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "User can click Export button in EnhancementPanel to download enhanced resources"
    - "Export downloads a zip file containing one PDF per differentiation level"
    - "Export includes answer key as separate PDF in the zip"
    - "PDFs are A4 portrait with binding margins (25mm left)"
    - "User sees progress during export generation"
  artifacts:
    - path: "services/exportService.ts"
      provides: "PDF generation, zip bundling, download trigger"
      exports: ["exportEnhancedResource", "PDF_CONFIG", "ExportProgress"]
    - path: "components/EnhancementPanel.tsx"
      provides: "Export button and progress UI"
      contains: "handleExport"
  key_links:
    - from: "components/EnhancementPanel.tsx"
      to: "services/exportService.ts"
      via: "exportEnhancedResource function call"
      pattern: "exportEnhancedResource\\("
    - from: "services/exportService.ts"
      to: "jspdf"
      via: "jsPDF text API"
      pattern: "new jsPDF\\("
    - from: "services/exportService.ts"
      to: "jszip"
      via: "JSZip bundling"
      pattern: "new JSZip\\("
---

<objective>
Create print-ready PDF export for enhanced resources with all differentiation levels bundled in a zip file.

Purpose: Teachers need to print enhanced worksheets for classroom use. Each differentiation level becomes a separate PDF so teachers can print the appropriate version for each student group. The zip bundle keeps all versions together in one download.

Output: exportService.ts with PDF generation + zip bundling, EnhancementPanel with Export button and progress feedback.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-export-and-persistence/47-CONTEXT.md
@.planning/phases/47-export-and-persistence/47-RESEARCH.md

# Existing files to extend
@components/EnhancementPanel.tsx
@types.ts

# Pattern reference
@components/ExportModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install JSZip and create export service with PDF generation</name>
  <files>
    package.json
    package-lock.json
    services/exportService.ts
  </files>
  <action>
Install jszip dependency:
```bash
npm install jszip
```

Create services/exportService.ts with:

1. PDF_CONFIG constant for A4 dimensions with binding margins:
   - pageWidth: 210mm, pageHeight: 297mm
   - marginLeft: 25mm (extra for binding/hole-punching)
   - marginRight: 15mm
   - marginTop: 20mm, marginBottom: 20mm
   - contentWidth getter: pageWidth - marginLeft - marginRight

2. ExportProgress interface:
   - phase: 'generating' | 'bundling'
   - percent: number (0-100)
   - currentFile?: string

3. renderEnhancedElementToPDF function accepting (doc: jsPDF, element: EnhancedElement, y: number, config: PDF_CONFIG):
   - Handle each element type (header, subheader, paragraph, instruction, question, list, table, blank-space, answer, diagram/image)
   - Use doc.setFontSize(), doc.setFont('helvetica', 'normal'|'bold')
   - Use doc.splitTextToSize() for line wrapping within contentWidth
   - Check page overflow: if y + lineHeight > pageBottom, call doc.addPage() and reset y
   - Return new y position after rendering
   - For headers: 16pt bold, extra spacing before
   - For paragraphs/instructions: 11pt normal, 6mm line height
   - For questions: 11pt bold with left border indicator (visual indent)
   - For lists: bullet points with indent
   - For blank-space: horizontal line for fill-in
   - For tables: use doc.autoTable if simple, or manual row rendering
   - For diagram/image: placeholder text "[Visual content preserved]"

4. generateWorksheetPDF function accepting (version: DifferentiatedVersion, title: string, levelName: string, edits: Map<number, string>):
   - Create jsPDF with orientation: 'portrait', unit: 'mm', format: 'a4'
   - Render header with levelName (e.g., "Simple Version")
   - Render document title
   - Iterate through version.elements, applying edits where they exist (edits.get(element.position) ?? element.enhancedContent)
   - Return jsPDF document

5. generateAnswerKeyPDF function accepting (answerKeys: AnswerKeyResult, title: string):
   - Create A4 portrait PDF
   - Render "Answer Key" header
   - For unified keys: render all items
   - For per-level keys: render with level headers
   - For closed questions: show answer
   - For open-ended: show criteria and exemplar

6. exportEnhancedResource async function accepting (result: EnhancementResult, editState: EditState, title: string, onProgress: (progress: ExportProgress) => void):
   - Create JSZip instance
   - Sanitize title for filename (remove special chars)
   - Generate PDF for each level (simple, standard, detailed) with appropriate edits
   - Add each PDF to zip with filename "{title} - {LevelName}.pdf"
   - Generate answer key PDF and add to zip
   - Generate zip blob with DEFLATE compression (level 6)
   - Trigger download via URL.createObjectURL + hidden anchor pattern
   - Call onProgress at each step

Use jsPDF's built-in Helvetica (no custom font embedding needed per RESEARCH.md recommendation).
  </action>
  <verify>
1. npm install succeeds without errors
2. package.json includes "jszip" in dependencies
3. TypeScript compiles: npm run typecheck
4. exportService.ts exports: exportEnhancedResource, PDF_CONFIG, ExportProgress
  </verify>
  <done>
Export service created with PDF generation for all differentiation levels, answer key generation, and zip bundling. JSZip installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Export button to EnhancementPanel with progress UI</name>
  <files>
    components/EnhancementPanel.tsx
  </files>
  <action>
Modify EnhancementPanel.tsx to add export functionality:

1. Add imports:
   - import { exportEnhancedResource, ExportProgress } from '../services/exportService';

2. Add state for export:
   - const [isExporting, setIsExporting] = useState(false);
   - const [exportProgress, setExportProgress] = useState<ExportProgress | null>(null);

3. Add handleExport async function:
   - Guard: if (!result) return
   - Set isExporting = true
   - Call exportEnhancedResource(result, editState, analysis.title || resource.filename, setExportProgress)
   - Wrap in try/catch, call onError on failure
   - Set isExporting = false in finally

4. In the results section (status === 'complete' && result), add Export button in the footer:
   - Position: Add to footer alongside existing "Regenerate Enhancement" button
   - Button styling: Primary style (bg-indigo-600) to make it prominent
   - Show progress when exporting: "{exportProgress?.phase === 'generating' ? 'Generating PDFs...' : 'Bundling...'} {exportProgress?.percent}%"
   - Disable button while exporting or regenerating
   - Icon: download icon (existing SVG pattern from codebase)

5. Update footer layout to accommodate two buttons:
   - Use flex row with gap-3
   - Export button on left (primary action)
   - Regenerate button on right (secondary)

Export button text states:
- Default: "Export All Versions"
- Exporting: "Generating PDFs... 25%" or "Bundling... 90%"
  </action>
  <verify>
1. TypeScript compiles: npm run typecheck
2. npm run build succeeds
3. Manual verification: In browser, complete an enhancement, Export button appears in footer
4. Clicking Export triggers download of zip file (test with actual enhancement)
  </verify>
  <done>
EnhancementPanel has Export button that generates and downloads zip containing all differentiation level PDFs plus answer key.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: npm run typecheck passes
2. Build: npm run build succeeds
3. Functional test:
   - Upload a resource in ResourceHub
   - Complete enhancement
   - Click "Export All Versions" button
   - Verify zip file downloads
   - Extract zip and verify:
     - 4 PDF files (Simple, Standard, Detailed, Answer Key)
     - Each PDF is A4 portrait
     - PDFs have binding margin (visible left margin)
     - Text is readable and properly wrapped
</verification>

<success_criteria>
- User can export enhanced resources as print-ready PDFs
- Export downloads automatically as a zip file
- Zip contains all three differentiation levels plus answer key
- PDFs are A4 with proper binding margins
- Progress feedback shown during export
</success_criteria>

<output>
After completion, create `.planning/phases/47-export-and-persistence/47-01-SUMMARY.md`
</output>
