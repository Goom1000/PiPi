---
phase: 04-save-load-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/Toast.tsx
  - hooks/useAutoSave.ts
  - components/RecoveryModal.tsx
autonomous: true

must_haves:
  truths:
    - "Toast can display success (green), error (red), and warning (amber) variants"
    - "App auto-saves presentation state to localStorage periodically"
    - "On app load, if auto-save exists, user sees recovery modal"
    - "User can choose to restore auto-save or start fresh"
  artifacts:
    - path: "components/Toast.tsx"
      provides: "Toast with variant prop for different colors"
      contains: "variant?: 'success' | 'error' | 'warning'"
    - path: "hooks/useAutoSave.ts"
      provides: "Auto-save hook with throttling"
      exports: ["useAutoSave"]
    - path: "components/RecoveryModal.tsx"
      provides: "Crash recovery modal with restore/discard options"
      exports: ["RecoveryModal"]
  key_links:
    - from: "components/Toast.tsx"
      to: "useToast hook"
      via: "addToast accepts variant parameter"
      pattern: "addToast.*variant"
    - from: "hooks/useAutoSave.ts"
      to: "localStorage"
      via: "localStorage.setItem for persistence"
      pattern: "localStorage\\.setItem"
---

<objective>
Add Toast variants for feedback and implement auto-save with crash recovery.

Purpose: Enable visual feedback for save/load operations and protect against data loss with auto-save.

Output: Toast.tsx extended with color variants; useAutoSave hook for periodic persistence; RecoveryModal for crash recovery UX.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-save-load-system/04-CONTEXT.md
@.planning/phases/04-save-load-system/04-RESEARCH.md

# Key existing patterns
@components/Toast.tsx (extend this)
@hooks/useSettings.ts (localStorage pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Toast.tsx with success/error/warning variants</name>
  <files>components/Toast.tsx</files>
  <action>
Modify Toast.tsx to add variant support:

1. Update ToastData interface:
   - Add: variant?: 'success' | 'error' | 'warning' | 'info'
   - Default behavior (no variant or 'info') keeps current green styling

2. Update useToast hook's addToast function:
   - Change signature: addToast(message: string, duration?: number, variant?: ToastData['variant'])
   - Pass variant to toast object

3. Update Toast component:
   - Accept variant prop (default to 'success' for backward compatibility)
   - Map variants to Tailwind colors:
     - success: bg-green-600 (existing)
     - error: bg-red-600
     - warning: bg-amber-500 text-slate-900 (dark text on amber)
     - info: bg-slate-700

4. Ensure backward compatibility:
   - Existing calls to addToast(message, duration) still work
   - Green is default if no variant specified
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Toast displays different colors based on variant prop; existing usage unchanged</done>
</task>

<task type="auto">
  <name>Task 2: Create useAutoSave hook with throttled localStorage persistence</name>
  <files>hooks/useAutoSave.ts</files>
  <action>
Create hooks/useAutoSave.ts with:

1. Constants:
   - AUTOSAVE_KEY = 'pipi-autosave'
   - AUTOSAVE_TIMESTAMP_KEY = 'pipi-autosave-timestamp'
   - AUTOSAVE_INTERVAL = 30000 (30 seconds)

2. AutoSaveData interface:
   - slides: Slide[]
   - studentNames: string[]
   - lessonText: string
   - lessonTitle: string

3. useAutoSave hook:
   - Parameters: data: AutoSaveData | null, enabled: boolean = true
   - Use useRef to track last save time
   - Use useEffect to save when data changes AND interval has passed
   - On save: JSON.stringify data, localStorage.setItem for both data and timestamp
   - Wrap in try-catch (localStorage can be full - just warn to console)
   - Clean up: No cleanup needed for throttle since we're using manual time check

4. Helper functions (exported):
   - getAutoSave(): AutoSaveData | null - Read from localStorage with validation
   - clearAutoSave(): void - Remove both keys from localStorage
   - hasAutoSave(): boolean - Check if auto-save exists

5. Validation:
   - Use simple type guard similar to isValidSettings pattern
   - Check slides is array, studentNames is array, lessonText/lessonTitle are strings

Per CONTEXT.md: "Auto-save architecture (same storage with flag vs separate backup)" - use separate keys for simplicity.

Per RESEARCH.md: Use throttle (not debounce) to ensure regular saves even during continuous editing.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>useAutoSave hook saves to localStorage every 30s; getAutoSave/clearAutoSave/hasAutoSave helpers work</done>
</task>

<task type="auto">
  <name>Task 3: Create RecoveryModal component for crash recovery</name>
  <files>components/RecoveryModal.tsx</files>
  <action>
Create components/RecoveryModal.tsx:

1. Props interface:
   - savedTitle: string (from recovered data, for display)
   - savedTimestamp: number (for "Last saved X minutes ago")
   - onRestore: () => void
   - onDiscard: () => void

2. Component:
   - Fixed overlay with dark backdrop (same pattern as SettingsModal)
   - Centered modal card with rounded corners
   - Heading: "Recover Unsaved Work?"
   - Subheading: Show relative time (e.g., "Last auto-saved 5 minutes ago")
   - Show presentation title from saved data
   - Two buttons:
     - "Restore" (primary, indigo/amber) - calls onRestore
     - "Start Fresh" (secondary, outlined) - calls onDiscard
   - Per CONTEXT.md: "Start fresh" means clear everything

3. Time formatting:
   - Calculate diff from now to savedTimestamp
   - < 1 min: "just now"
   - < 60 min: "X minutes ago"
   - >= 60 min: "X hours ago"

4. Styling:
   - Follow existing modal patterns (EnableAIModal, SettingsModal)
   - Support dark mode with dark: variants
   - Use font-fredoka for headings
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>RecoveryModal displays recovery prompt with restore/discard options and relative timestamp</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - No TypeScript errors
2. Toast.tsx has variant prop with 4 color options
3. hooks/useAutoSave.ts exists with useAutoSave hook and helper functions
4. components/RecoveryModal.tsx exists and matches existing modal patterns
</verification>

<success_criteria>
- Toast shows green/red/amber/gray based on variant
- Auto-save writes to localStorage every 30 seconds
- RecoveryModal displays with restore/discard options
- All existing Toast usage continues to work (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/04-save-load-system/04-02-SUMMARY.md`
</output>
