---
phase: 04-save-load-system
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - hooks/useDragDrop.ts
  - App.tsx
autonomous: false

must_haves:
  truths:
    - "User can click Save button in header to download .pipi file"
    - "User is prompted for filename before save (auto-suggested from title)"
    - "User can click Load button to open file picker for .pipi files"
    - "User can drag-drop .pipi file anywhere on window to load"
    - "App shows success toast after save/load completes"
    - "App shows error toast with explanation if save/load fails"
    - "App shows warning toast if file exceeds 50MB (but still saves)"
    - "App checks for auto-save on load and shows RecoveryModal if found"
    - "App auto-saves presentation state while editing"
  artifacts:
    - path: "hooks/useDragDrop.ts"
      provides: "Window-level drag-drop handling for .pipi files"
      exports: ["useDragDrop"]
    - path: "App.tsx"
      provides: "Save/Load buttons, drag-drop integration, recovery flow, auto-save"
      contains: ["Save", "Load", "useDragDrop", "RecoveryModal"]
  key_links:
    - from: "App.tsx"
      to: "services/saveService.ts"
      via: "downloadPresentation call on save"
      pattern: "downloadPresentation"
    - from: "App.tsx"
      to: "services/loadService.ts"
      via: "readPiPiFile call on load"
      pattern: "readPiPiFile"
    - from: "App.tsx"
      to: "hooks/useAutoSave.ts"
      via: "useAutoSave hook call"
      pattern: "useAutoSave"
    - from: "App.tsx"
      to: "hooks/useDragDrop.ts"
      via: "useDragDrop hook for window drop handling"
      pattern: "useDragDrop"

user_setup: []
---

<objective>
Wire save/load functionality into the app UI with full user experience.

Purpose: Connect all save/load services to the UI, enabling users to save presentations, load them back, and recover from crashes.

Output: Fully functional save/load system with header buttons, drag-drop support, toast feedback, and auto-save recovery.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-save-load-system/04-CONTEXT.md
@.planning/phases/04-save-load-system/04-RESEARCH.md
@.planning/phases/04-save-load-system/04-01-SUMMARY.md
@.planning/phases/04-save-load-system/04-02-SUMMARY.md

# Integration targets
@App.tsx
@components/Toast.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDragDrop hook for window-level file drop</name>
  <files>hooks/useDragDrop.ts</files>
  <action>
Create hooks/useDragDrop.ts:

1. Hook signature: useDragDrop(onFile: (file: File) => void, enabled: boolean = true)

2. Use useEffect to attach window-level event listeners:
   - dragover: e.preventDefault(), e.stopPropagation() (required to enable drop)
   - drop: e.preventDefault(), e.stopPropagation(), check for .pipi file

3. On drop:
   - Get file from e.dataTransfer?.files[0]
   - Check file.name ends with '.pipi'
   - If valid, call onFile(file)
   - If invalid .pipi file, ignore (load service will show error if user picked wrong file via picker)

4. Cleanup:
   - Remove both event listeners on unmount or when enabled changes to false

5. When enabled is false:
   - Don't attach listeners (allows disabling during modals, etc.)

Per CONTEXT.md: "No visible drop zone - drop anywhere on window, just works"
Per RESEARCH.md: Pattern 4 (Window-Level Drag Drop)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>useDragDrop hook handles window-level drag-drop for .pipi files</done>
</task>

<task type="auto">
  <name>Task 2: Integrate save/load into App.tsx header and state</name>
  <files>App.tsx</files>
  <action>
Modify App.tsx to add full save/load integration:

**Imports to add:**
- createPiPiFile, downloadPresentation, checkFileSize from './services/saveService'
- readPiPiFile from './services/loadService'
- useAutoSave, getAutoSave, clearAutoSave, hasAutoSave from './hooks/useAutoSave'
- useDragDrop from './hooks/useDragDrop'
- RecoveryModal from './components/RecoveryModal'
- useToast, ToastContainer from './components/Toast'

**State to add:**
- const { toasts, addToast, removeToast } = useToast()
- const [showRecoveryModal, setShowRecoveryModal] = useState(false)
- const [recoveryData, setRecoveryData] = useState<AutoSaveData | null>(null)
- const [recoveryTimestamp, setRecoveryTimestamp] = useState<number>(0)
- const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false)
- const loadFileInputRef = useRef<HTMLInputElement>(null)
- const [showFilenamePrompt, setShowFilenamePrompt] = useState(false)
- const [pendingSaveFilename, setPendingSaveFilename] = useState('')

**Auto-save integration:**
- Call useAutoSave with { slides, studentNames, lessonText, lessonTitle } when appState is EDITING
- Set enabled = (appState === AppState.EDITING && slides.length > 0)

**Recovery on mount:**
- useEffect on mount: check hasAutoSave()
- If true, read data with getAutoSave() and timestamp
- Set recoveryData and recoveryTimestamp, show RecoveryModal
- onRestore: apply data to state (setSlides, setStudentNames, etc.), clearAutoSave(), setAppState(EDITING)
- onDiscard: clearAutoSave(), hide modal

**Save flow (per CONTEXT.md: always prompt for filename):**
- Save button click: check file size first
  - If exceeds 50MB: addToast('This presentation is over 50MB...', 5000, 'warning')
- Open filename prompt modal (simple input with lessonTitle as default)
- On confirm: downloadPresentation(file, filename), addToast('Saved successfully!', 3000, 'success')

**Load flow:**
- Add hidden file input for .pipi files
- Load button click: trigger file input click
- On file selected: call handleLoadFile(file)
- handleLoadFile:
  - If hasUnsavedChanges, show confirm: "You have unsaved changes. Continue?"
  - Call readPiPiFile(file), wrap in try-catch
  - On success: apply loaded data to state, addToast('Loaded successfully!', 3000, 'success'), clearAutoSave()
  - On error: addToast(error.message, 5000, 'error')

**Drag-drop integration:**
- Call useDragDrop(handleLoadFile, enabled) where enabled = !showSettings && !showResourceHub && appState !== PRESENTING
- This reuses the same handleLoadFile logic

**Unsaved changes tracking:**
- Set hasUnsavedChanges = true when slides/lessonText/studentNames change (after initial load)
- Clear hasUnsavedChanges after successful save or load

**beforeunload warning:**
- useEffect with beforeunload listener when hasUnsavedChanges is true
- Return empty string to trigger browser's generic warning

**Header buttons (in EDITING state, next to existing Export PPTX button):**
- Add "Save" button (indigo/amber, same style as Export PPTX)
- Add "Load" button (secondary style)
- Add hidden file input with ref

**ToastContainer:**
- Render ToastContainer at end of main component (before closing </div>)
  </action>
  <verify>
1. `npx tsc --noEmit` - No TypeScript errors
2. `npm run dev` - App runs without console errors
3. Save and Load buttons visible in header when editing
  </verify>
  <done>App.tsx has Save/Load buttons, drag-drop, auto-save, recovery modal, and toast feedback</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete save/load system:
- Save button prompts for filename, downloads .pipi file
- Load button opens file picker for .pipi files
- Drag-drop .pipi files anywhere on window
- Success/error/warning toasts for all operations
- Auto-save every 30 seconds while editing
- Recovery modal on app load if auto-save exists
- 50MB warning before save
  </what-built>
  <how-to-verify>
1. Start app: `npm run dev`
2. Generate or create some slides to enter EDITING state
3. Test Save:
   - Click "Save" in header
   - Verify filename prompt appears with lesson title as default
   - Confirm save - verify .pipi file downloads
   - Verify success toast appears (green)
4. Test Load via file picker:
   - Click "Load" in header
   - Select the .pipi file you just saved
   - Verify presentation loads correctly
   - Verify success toast appears
5. Test Load via drag-drop:
   - Drag the .pipi file onto the browser window
   - Verify presentation loads
6. Test error handling:
   - Try to load a non-.pipi file (should show error toast)
   - Try to load a corrupted/invalid file (should show error toast)
7. Test auto-save recovery:
   - Make some changes, wait 30+ seconds
   - Hard refresh the browser (Cmd+R)
   - Verify RecoveryModal appears
   - Click "Restore" - verify presentation restored
   - Repeat and click "Start Fresh" - verify starts empty
8. Test unsaved changes warning:
   - Make changes
   - Try to close tab or navigate away
   - Verify browser shows warning
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - No TypeScript errors
2. Save button downloads .pipi file with prompted filename
3. Load button opens file picker and loads selected file
4. Drag-drop works anywhere on window
5. Toast feedback shows for all operations
6. Auto-save works and recovery modal appears on reload
7. 50MB warning shows but save still proceeds
</verification>

<success_criteria>
- SAVE-01: Export current presentation to downloadable .pipi file - DONE
- SAVE-02: Import presentation from .pipi file via file picker - DONE
- SAVE-03: Drag-and-drop .pipi file onto app to load - DONE
- SAVE-04: App shows success toast after save completes - DONE
- SAVE-05: App shows error toast with explanation if save/load fails - DONE
- SAVE-06: App warns user if presentation exceeds 50MB before saving - DONE
- SAVE-07: App auto-saves to localStorage for crash recovery - DONE
- SAVE-08: Filename auto-suggests from presentation title - DONE
</success_criteria>

<output>
After completion, create `.planning/phases/04-save-load-system/04-03-SUMMARY.md`
</output>
