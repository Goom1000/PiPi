---
phase: 04-save-load-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types.ts
  - services/saveService.ts
  - services/loadService.ts
autonomous: true

must_haves:
  truths:
    - "Presentation data can be serialized to JSON with version metadata"
    - "Serialized data can be downloaded as .pipi file"
    - ".pipi file can be read and parsed back to presentation state"
    - "Invalid or corrupted files produce clear error messages"
    - "Files exceeding 50MB trigger warning (but save still allowed)"
  artifacts:
    - path: "types.ts"
      provides: "PiPiFile interface with version, metadata, content"
      contains: "interface PiPiFile"
    - path: "services/saveService.ts"
      provides: "Download file, check size, create file object"
      exports: ["downloadPresentation", "checkFileSize", "createPiPiFile"]
    - path: "services/loadService.ts"
      provides: "Read file, validate, parse, migrate versions"
      exports: ["readPiPiFile", "isValidPiPiFile"]
  key_links:
    - from: "services/saveService.ts"
      to: "types.ts"
      via: "PiPiFile type import"
      pattern: "import.*PiPiFile.*from"
    - from: "services/loadService.ts"
      to: "types.ts"
      via: "PiPiFile type import"
      pattern: "import.*PiPiFile.*from"
---

<objective>
Create the core save/load services for .pipi file format.

Purpose: Establish the file format, serialization, and file I/O primitives that all save/load features depend on.

Output: types.ts extended with PiPiFile interface; saveService.ts and loadService.ts providing all file operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-save-load-system/04-CONTEXT.md
@.planning/phases/04-save-load-system/04-RESEARCH.md

# Key existing patterns
@types.ts
@hooks/useSettings.ts (isValidSettings pattern for type guards)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define PiPiFile interface and add to types.ts</name>
  <files>types.ts</files>
  <action>
Add PiPiFile interface to types.ts with these fields:
- version: number (start at 1, increment on breaking changes)
- createdAt: string (ISO 8601)
- modifiedAt: string (ISO 8601)
- title: string (presentation title)
- author?: string (optional)
- content: object containing:
  - slides: Slide[]
  - studentNames: string[]
  - lessonText: string

Also add:
- CURRENT_FILE_VERSION constant (= 1)
- PiPiFileContent type for the content object

Place these after the existing Settings interface for logical grouping.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>PiPiFile interface exists in types.ts with all required fields</done>
</task>

<task type="auto">
  <name>Task 2: Create saveService.ts with download and size-check functions</name>
  <files>services/saveService.ts</files>
  <action>
Create services/saveService.ts with these exports:

1. `createPiPiFile(title: string, slides: Slide[], studentNames: string[], lessonText: string, existingFile?: PiPiFile): PiPiFile`
   - Creates file object with current timestamp for modifiedAt
   - If existingFile provided, preserve createdAt; otherwise use current time
   - Always use CURRENT_FILE_VERSION

2. `checkFileSize(file: PiPiFile): { sizeBytes: number; sizeMB: number; exceeds50MB: boolean }`
   - Serialize to JSON, create Blob, return blob.size
   - Calculate sizeMB as sizeBytes / (1024 * 1024)
   - exceeds50MB = sizeMB > 50

3. `downloadPresentation(file: PiPiFile, filename: string): void`
   - Serialize file to JSON with pretty-print (null, 2)
   - Create Blob with type 'application/json'
   - Create object URL, create hidden anchor, trigger click
   - Ensure filename ends with .pipi
   - Clean up: remove anchor, setTimeout 100ms then revokeObjectURL (Firefox needs delay)

Use pattern from RESEARCH.md for Blob download with memory cleanup.
  </action>
  <verify>
Create test file and verify:
```bash
echo "import { createPiPiFile, checkFileSize } from './services/saveService';
const file = createPiPiFile('Test', [], [], '');
console.log('Size check:', checkFileSize(file));" > /tmp/test-save.ts
```
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>saveService.ts exports createPiPiFile, checkFileSize, downloadPresentation with correct logic</done>
</task>

<task type="auto">
  <name>Task 3: Create loadService.ts with file reading and validation</name>
  <files>services/loadService.ts</files>
  <action>
Create services/loadService.ts with these exports:

1. `isValidPiPiFile(data: unknown): data is PiPiFile`
   - Follow existing isValidSettings pattern from useSettings.ts
   - Check: typeof data === 'object', data !== null
   - Validate version is number
   - Validate title is string
   - Validate content is object with slides array
   - Return true only if all checks pass

2. `readPiPiFile(file: File): Promise<PiPiFile>`
   - Check file.name ends with '.pipi' (throw Error if not: "Invalid file type. Expected .pipi file.")
   - Use FileReader.readAsText wrapped in Promise
   - Parse JSON (wrap in try-catch, throw "File contains invalid JSON." on parse error)
   - Validate with isValidPiPiFile (throw "File format is corrupted or incompatible." if invalid)
   - Handle version migration: if version < CURRENT_FILE_VERSION, call migrateFile
   - Return validated PiPiFile

3. `migrateFile(data: PiPiFile): PiPiFile` (internal, not exported)
   - For now, just return data unchanged (version 1 is current)
   - Log to console: "Migrating file from version X to Y"
   - This is future-proofing for when schema evolves

Error messages must be user-friendly (will be shown in toast).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>loadService.ts exports isValidPiPiFile, readPiPiFile with validation and error handling</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - No TypeScript errors
2. types.ts contains PiPiFile interface
3. services/saveService.ts exists with 3 exports
4. services/loadService.ts exists with 2 exports
5. Both services import PiPiFile from types.ts
</verification>

<success_criteria>
- PiPiFile type defined with version, metadata, and content structure
- Save service can create file objects, check size, trigger browser download
- Load service can read .pipi files with validation and clear error messages
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-save-load-system/04-01-SUMMARY.md`
</output>
