---
phase: 20-game-foundation
plan: 03
type: execute
wave: 3
depends_on: ["20-01", "20-02"]
files_modified:
  - components/PresentationView.tsx
  - components/StudentView.tsx
  - components/StudentGameView.tsx
  - index.html
autonomous: true

must_haves:
  truths:
    - "Teacher can select game from dropdown and Quick Quiz works identically to before"
    - "Selecting placeholder game shows splash with Coming Soon"
    - "Game state syncs to student view via BroadcastChannel"
    - "Switching games mid-game shows confirmation dialog"
    - "Escape key or X button closes game and returns to presentation"
    - "Flash animation plays on correct answer reveal"
  artifacts:
    - path: "components/PresentationView.tsx"
      provides: "Integrated game menu and GameContainer"
      contains: "GameMenu"
    - path: "components/StudentView.tsx"
      provides: "Updated to handle new GameState"
      contains: "GameState"
    - path: "components/StudentGameView.tsx"
      provides: "Updated to render all game types"
      contains: "switch.*gameType"
    - path: "index.html"
      provides: "Flash reveal and crossfade CSS animations"
      contains: "animate-flash-correct"
  key_links:
    - from: "components/PresentationView.tsx"
      to: "components/games/GameContainer.tsx"
      via: "GameContainer render"
      pattern: "<GameContainer"
    - from: "components/PresentationView.tsx"
      to: "hooks/useBroadcastSync.ts"
      via: "GAME_STATE_UPDATE message"
      pattern: "GAME_STATE_UPDATE"
---

<objective>
Integrate the game system into PresentationView, update student views, and add CSS animations.

Purpose: Wire together all the pieces so teachers can launch games from the menu, play Quick Quiz identically to before, and have state sync to student view.

Output:
- PresentationView updated to use GameMenu and GameContainer
- StudentView and StudentGameView updated for new GameState types
- CSS animations for flash reveal and crossfade transitions
- Game switching confirmation dialog
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-game-foundation/20-CONTEXT.md
@.planning/phases/20-game-foundation/20-RESEARCH.md
@.planning/phases/20-game-foundation/20-01-SUMMARY.md
@.planning/phases/20-game-foundation/20-02-SUMMARY.md
@types.ts
@components/PresentationView.tsx
@components/StudentView.tsx
@components/StudentGameView.tsx
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSS animations to index.html</name>
  <files>index.html</files>
  <action>
Add the following CSS animations inside the existing `<style>` tag in index.html:

```css
/* Flash animation for correct answer reveal - TV show style */
@keyframes flashReveal {
  0% {
    background-color: inherit;
    transform: scale(1);
  }
  15% {
    background-color: white;
    transform: scale(1.02);
    box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
  }
  30% {
    background-color: inherit;
    transform: scale(1);
  }
  45% {
    background-color: white;
    transform: scale(1.01);
  }
  60% {
    background-color: #22c55e;
    transform: scale(1.05);
    box-shadow: 0 0 40px rgba(34, 197, 94, 0.5);
  }
  100% {
    background-color: #22c55e;
    transform: scale(1);
    box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
  }
}

.animate-flash-correct {
  animation: flashReveal 0.8s ease-out forwards;
}

/* Crossfade for game transitions */
@keyframes crossfadeIn {
  from { opacity: 0; transform: scale(0.98); }
  to { opacity: 1; transform: scale(1); }
}

@keyframes crossfadeOut {
  from { opacity: 1; transform: scale(1); }
  to { opacity: 0; transform: scale(1.02); }
}

.animate-crossfade-in {
  animation: crossfadeIn 0.3s ease-out forwards;
}

.animate-crossfade-out {
  animation: crossfadeOut 0.3s ease-in forwards;
}
```

These should be added after the existing animate-fade-in keyframes.
  </action>
  <verify>index.html contains animate-flash-correct and animate-crossfade-in classes</verify>
  <done>CSS animations for flash reveal and crossfade added to index.html</done>
</task>

<task type="auto">
  <name>Task 2: Update StudentGameView for new GameState types</name>
  <files>components/StudentGameView.tsx</files>
  <action>
Update StudentGameView.tsx to handle the new GameState discriminated union:

1. Update imports:
```typescript
import { GameState, assertNever } from '../types';
```

2. Update props interface:
```typescript
interface StudentGameViewProps {
  gameState: GameState;
}
```

3. Refactor to use discriminated union switch for rendering. The component should:
   - Show GameSplash during 'loading' or 'splash' status
   - For 'quick-quiz': render existing play mode UI (questions/options) - keep current logic
   - For 'millionaire', 'the-chase', 'beat-the-chaser': show GameSplash with game branding
   - Show ResultScreen for 'result' status

Key changes:
- Replace `GameSyncState` with `GameState` throughout
- Add switch on `gameState.gameType` for game-specific rendering
- Use assertNever in default case
- Import GameSplash and ResultScreen from games/shared/

Example structure:
```typescript
const StudentGameView: React.FC<StudentGameViewProps> = ({ gameState }) => {
  // Loading state
  if (gameState.status === 'loading') {
    return <LoadingScreen gameType={gameState.gameType} />;
  }

  // Result state
  if (gameState.status === 'result') {
    return <StudentResultScreen gameType={gameState.gameType} />;
  }

  // Game-specific rendering
  switch (gameState.gameType) {
    case 'quick-quiz':
      return <QuickQuizStudentView state={gameState} />;
    case 'millionaire':
      return <PlaceholderStudentView gameType="millionaire" />;
    case 'the-chase':
      return <PlaceholderStudentView gameType="the-chase" />;
    case 'beat-the-chaser':
      return <PlaceholderStudentView gameType="beat-the-chaser" />;
    default:
      return assertNever(gameState);
  }
};
```

Keep the existing Quick Quiz rendering logic (questions grid, answer reveal) but wrap it in the switch case.

For placeholder games, show GameSplash with "Waiting for teacher..." message.
  </action>
  <verify>Run `npx tsc --noEmit` to verify types compile</verify>
  <done>StudentGameView handles all game types with discriminated union switch</done>
</task>

<task type="auto">
  <name>Task 3: Update PresentationView to use new game system</name>
  <files>components/PresentationView.tsx</files>
  <action>
Major refactor of PresentationView.tsx to integrate new game system. This is the largest change:

1. **Update imports** - Add:
```typescript
import { GameState, GameType, QuickQuizState, ActiveGameState } from '../types';
import GameMenu from './games/GameMenu';
import GameContainer from './games/GameContainer';
```

2. **Update state** - Replace:
```typescript
// OLD:
const [isQuizModalOpen, setIsQuizModalOpen] = useState(false);
const [gameState, setGameState] = useState<GameSyncState | null>(null);

// NEW:
const [activeGame, setActiveGame] = useState<ActiveGameState>(null);
const [pendingGameType, setPendingGameType] = useState<GameType | null>(null);
```

3. **Add factory function** for creating fresh game state:
```typescript
const createQuickQuizState = (questions: QuizQuestion[]): QuickQuizState => ({
  gameType: 'quick-quiz',
  status: 'playing',
  questions,
  currentQuestionIndex: 0,
  isAnswerRevealed: false,
});
```

4. **Add game launch handler** with confirmation for mid-game switch:
```typescript
const handleSelectGame = useCallback((gameType: GameType) => {
  // If game is active and not finished, confirm switch
  if (activeGame && activeGame.status !== 'result') {
    const confirmed = window.confirm('A game is in progress. Switch to a different game?');
    if (!confirmed) return;
  }

  if (gameType === 'quick-quiz') {
    // Launch Quick Quiz - needs to generate questions first
    setPendingGameType('quick-quiz');
    launchQuickQuiz();
  } else {
    // Launch placeholder game directly
    setActiveGame(createPlaceholderState(gameType));
  }
}, [activeGame]);
```

5. **Add placeholder state factory**:
```typescript
const createPlaceholderState = (gameType: GameType): GameState => {
  const base = {
    status: 'splash' as const,
    questions: [],
    currentQuestionIndex: 0,
  };
  switch (gameType) {
    case 'millionaire':
      return { ...base, gameType: 'millionaire', selectedOption: null, lifelines: { fiftyFifty: true, phoneAFriend: true, askTheAudience: true }, prizeLadder: [], currentPrize: 0 };
    case 'the-chase':
      return { ...base, gameType: 'the-chase', chaserPosition: 0, contestantPosition: 0, isChasing: false };
    case 'beat-the-chaser':
      return { ...base, gameType: 'beat-the-chaser', contestantTime: 0, chaserTime: 0, activePlayer: 'contestant' };
    default:
      throw new Error(`Unknown game type: ${gameType}`);
  }
};
```

6. **Refactor Quick Quiz launch** - Extract from QuizOverlay:
```typescript
const launchQuickQuiz = async () => {
  if (!provider) {
    onRequestAI('start the quiz game');
    setPendingGameType(null);
    return;
  }

  // Set loading state
  setActiveGame({
    gameType: 'quick-quiz',
    status: 'loading',
    questions: [],
    currentQuestionIndex: 0,
    isAnswerRevealed: false,
  });

  try {
    const questions = await provider.generateImpromptuQuiz(slides, currentIndex, 5);
    setActiveGame(createQuickQuizState(questions));
  } catch (e) {
    console.error(e);
    if (e instanceof AIProviderError) {
      onError('Quiz Generation Failed', e.userMessage);
    } else {
      onError('Error', 'Could not generate quiz. Please try again.');
    }
    setActiveGame(null);
  }
  setPendingGameType(null);
};
```

7. **Add game control handlers**:
```typescript
const handleRevealAnswer = useCallback(() => {
  if (activeGame?.gameType === 'quick-quiz') {
    setActiveGame(prev => prev ? { ...prev, isAnswerRevealed: true, status: 'reveal' as const } : null);
  }
}, [activeGame]);

const handleNextQuestion = useCallback(() => {
  if (activeGame?.gameType === 'quick-quiz') {
    const state = activeGame as QuickQuizState;
    if (state.currentQuestionIndex < state.questions.length - 1) {
      setActiveGame({
        ...state,
        currentQuestionIndex: state.currentQuestionIndex + 1,
        isAnswerRevealed: false,
        status: 'playing',
      });
    } else {
      setActiveGame({ ...state, status: 'result' });
    }
  }
}, [activeGame]);

const handleCloseGame = useCallback(() => {
  setActiveGame(null);
}, []);

const handleRestartGame = useCallback(() => {
  if (activeGame?.gameType === 'quick-quiz') {
    launchQuickQuiz();
  }
}, [activeGame, launchQuickQuiz]);
```

8. **Update BroadcastChannel sync** - Replace GameSyncState with GameState:
```typescript
// Broadcast game state changes
useEffect(() => {
  if (activeGame) {
    gameWasOpenRef.current = true;
    postMessage({
      type: 'GAME_STATE_UPDATE',
      payload: activeGame  // Now sends full GameState
    });
  } else if (gameWasOpenRef.current) {
    postMessage({ type: 'GAME_CLOSE' });
    gameWasOpenRef.current = false;
  }
}, [activeGame, postMessage]);
```

9. **Replace Quiz button with GameMenu** in toolbar:
```tsx
{/* OLD Quiz Button - REMOVE */}

{/* NEW Game Menu */}
<div className="relative">
  <GameMenu
    onSelectGame={handleSelectGame}
    disabled={!isAIAvailable && pendingGameType === null}
  />
  {!isAIAvailable && (
    <span className="absolute -top-1 -right-1 w-4 h-4 bg-slate-500 rounded-full flex items-center justify-center">
      <svg className="w-2.5 h-2.5 text-white" viewBox="0 0 20 20" fill="currentColor">
        <path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" />
      </svg>
    </span>
  )}
</div>
```

10. **Replace QuizOverlay portal with GameContainer**:
```tsx
{/* OLD QuizOverlay - REMOVE entirely */}

{/* NEW Game Modal */}
{activeGame && createPortal(
  <div className="absolute inset-0 z-[100] bg-slate-900/95 backdrop-blur-md flex items-center justify-center animate-crossfade-in font-poppins">
    {/* Close button */}
    <button
      onClick={handleCloseGame}
      className="absolute top-6 right-6 p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors z-50"
    >
      <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <GameContainer
      state={activeGame}
      onClose={handleCloseGame}
      onRevealAnswer={handleRevealAnswer}
      onNextQuestion={handleNextQuestion}
      onRestart={handleRestartGame}
    />
  </div>,
  document.body
)}
```

11. **Remove the QuizOverlay component** - It's been replaced by GameContainer + QuickQuizGame. Delete the entire QuizOverlay function definition from PresentationView.tsx.

12. **Update STATE_REQUEST handler** to send activeGame instead of gameState:
```typescript
if (lastMessage?.type === 'STATE_REQUEST') {
  postMessage({
    type: 'STATE_UPDATE',
    payload: { currentIndex, visibleBullets, slides }
  });
  if (activeGame) {
    postMessage({
      type: 'GAME_STATE_UPDATE',
      payload: activeGame
    });
  }
}
```
  </action>
  <verify>Run `npx tsc --noEmit` and manually verify Quick Quiz works as before</verify>
  <done>PresentationView uses GameMenu dropdown and GameContainer, Quick Quiz works identically</done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] index.html contains animate-flash-correct CSS animation
- [ ] Clicking "Game Mode" button shows dropdown with 4 game options
- [ ] Selecting "Quick Quiz" generates questions and shows quiz UI
- [ ] Quick Quiz reveal answer triggers flash animation on correct answer
- [ ] Selecting placeholder game shows splash screen with "Coming Soon"
- [ ] Student view receives and displays game state correctly
- [ ] Closing game returns to presentation at same slide
- [ ] Switching games mid-game shows confirmation dialog
</verification>

<success_criteria>
- Teacher can select from game menu showing all 4 options
- Quick Quiz works identically to before (generate, play, reveal, next, finish)
- Game state syncs to student view without cross-contamination
- Flash animation plays on correct answer reveal
- Switching games clears previous state and confirms if mid-game
- Escape/X closes game overlay
</success_criteria>

<output>
After completion, create `.planning/phases/20-game-foundation/20-03-SUMMARY.md`
</output>
